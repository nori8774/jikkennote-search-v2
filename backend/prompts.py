"""
Default prompts for the agent
エージェントのデフォルトプロンプト定義
これらのプロンプトはUIから編集可能

v3.1.0: 3軸分離検索対応
- focus_classification: 重点指示の分類
- material_query_generation: 材料軸クエリ生成
- method_query_generation: 方法軸クエリ生成
- combined_query_generation: 総合軸クエリ生成（旧query_generation）
- compare: 比較分析（変更なし）
"""

# デフォルトプロンプト定義
DEFAULT_PROMPTS = {
    "normalize": {
        "name": "正規化ノード",
        "description": "材料名の表記揺れを統一",
        "prompt": """（このノードはプロンプトを使用しません。材料名の正規化処理を行います）"""
    },

    # v3.1.0: 重点指示分類プロンプト（新規）
    "focus_classification": {
        "name": "重点指示分類",
        "description": "重点指示が材料/方法/両方/なしのどれに関連するかを判定",
        "prompt": """# Task
ユーザーの[重点指示]を分析し、それが「材料」「方法」「両方」「該当なし」のいずれに関連するかを判定してください。

# Input
[重点指示] {user_focus_instruction}

# 判定基準

## "materials"（材料関連）
以下のキーワードや意図が含まれる場合:
- 材料、試薬、化学物質の名前（NaOH、エタノール、抗体など）
- 容量、濃度、量（mL、mol/L、%など）
- 材料の変更、追加、削除に関する指示

## "methods"（方法関連）
以下のキーワードや意図が含まれる場合:
- 操作、手順、方法に関する単語（撹拌、分散、加熱、冷却など）
- 時間、温度、回転数、圧力などの条件
- 手順の変更、順序の変更に関する指示

## "both"（両方に関連）
以下の場合:
- 材料と方法の両方に関連するキーワードが含まれる
- 例: 「NaOH濃度を上げて撹拌時間を延ばした実験」

## "none"（該当なし）
以下の場合:
- 重点指示が空または「特になし」
- 材料にも方法にも直接関連しない一般的な指示

# 出力形式
以下のJSON形式のみを出力してください。説明は不要です。

{{
  "classification": "materials" | "methods" | "both" | "none",
  "reason": "判定理由を簡潔に（日本語）"
}}"""
    },

    # v3.1.0: 材料軸クエリ生成プロンプト（新規）
    "material_query_generation": {
        "name": "材料軸クエリ生成",
        "description": "材料情報に特化した検索クエリを生成",
        "prompt": """# Role
あなたは生物・化学分野の材料検索エキスパートです。

# Task
ユーザーの[材料]情報から、材料に特化した検索クエリを生成してください。
容量、濃度などの数値情報を重視してください。

# Input Data
[材料(正規化済)] {normalized_materials}
[重点指示] {user_focus_instruction}

# 生成ルール

## 1. 材料名と数値を結合
- 物質名と数値をセットで記述
- 例: "精製水25mL", "NaOH 10mL 0.1mol/L"

## 2. 重点指示の反映
[重点指示]が材料に関連する場合のみ、その観点を含めてください。

## 3. クエリの構成
- 主要な材料名（化学物質名）
- 容量・濃度の数値
- 重点指示で指定された観点（該当する場合）

# 出力形式
検索クエリ文字列のみを、以下のJSON形式で出力してください。

{{
  "query": "材料に特化した検索クエリ文字列"
}}"""
    },

    # v3.1.0: 方法軸クエリ生成プロンプト（v3.2.0: 材料情報を追加）
    "method_query_generation": {
        "name": "方法軸クエリ生成",
        "description": "方法・手順情報に特化した検索クエリを生成（材料との参照解決付き）",
        "prompt": """# Role
あなたは実験プロセスの文脈解析と検索クエリ生成の専門家です。
実験の「手順（Method）」を検索クエリ化する際、単なる操作の羅列ではなく、**「何を（Materials）」扱っているかを明確にした文章**を作成します。

# Task
入力された[材料]と[方法]を統合し、指示語（①、②、液A、試薬1など）を**具体的な「物質名＋容量」に書き換えた**検索クエリを生成してください。

# Input Data
[材料(正規化済)] {normalized_materials}
[方法] {input_methods}
[重点指示] {user_focus_instruction}

# 生成ルール

## 1. 参照解決 (Reference Resolution)
[方法]の記述内にある「①」「混合液」「試薬A」などの抽象的な言葉を、必ず[材料]リストにある**具体的な「化学物質名」と「容量」**に置換してください。
* ❌ 悪い例: "①と②を混ぜて、撹拌する（80rpm）"
* ⭕ 良い例: "精製水25mLとHbA1c捕捉抗体1mLを混合し、80rpmで撹拌する"

## 2. 操作条件の完全保持
[方法]に含まれる数値条件（温度、時間、回転数、濃度など）は、実験を特定する指紋です。これらを**絶対に省略せず**、文章の中に組み込んでください。
* 形式: "[物質名]を[操作]（[条件]）"

## 3. 重点指示の反映
[重点指示]が方法に関連する場合のみ、その観点を含めてください。

# 出力形式
検索クエリ文字列のみを、以下のJSON形式で出力してください。

{{
  "query": "物質名と操作条件を統合した検索クエリ文字列"
}}"""
    },

    # v3.1.0: 総合軸クエリ生成プロンプト（旧query_generationを改名）
    "combined_query_generation": {
        "name": "総合軸クエリ生成",
        "description": "目的・材料・方法を総合した検索クエリを生成（3視点）",
        "prompt": """# Role
あなたは生物・化学分野に精通したプロフェッショナルであり、高度な実験ノート検索エージェントです。

# Task
ユーザーの入力情報（目的、材料、方法、重点指示）を深く分析し、多様な視点から検索クエリを生成してください。

# Input Data
[目的] {input_purpose}
[材料(正規化済)] {normalized_materials}
[方法] {input_methods}
[重点指示] {user_focus_instruction}

# 重要な検索方針（必ず従うこと）

## 1. **重点指示を最優先**
[重点指示]が提供されている場合、この指示に従って検索クエリを生成してください。
重点指示は、ユーザーが最も重視する観点を示しています。

## 2. **目的が空の場合の特別ルール**
[目的]が空または「特になし」の場合：
- **材料（化学物質名、容量）と方法（化学物質、容量、手順）の記述が類似している実験ノートを最優先**してください。
- 具体的な物質名、容量、操作手順などのキーワードを重視してください。
- 意味的な類似性よりも、事実ベースの一致を重視してください。

## 3. **目的がある場合の方針**
[目的]が明確に記載されている場合：
- 目的の意図・背景を重視してください（Semantic Search向け）。
- ただし、[重点指示]がある場合は、その指示を優先してください。

# 思考プロセス（出力不要）
1. **重点指示の確認**: [重点指示]の内容を最優先で理解する。
2. **目的の有無を確認**: [目的]が空かどうかで検索戦略を切り替える。
   - 目的が空 → 材料・方法のキーワード一致を最重視
   - 目的がある → 意図・背景も考慮（ただし重点指示優先）
3. **構造化**: 材料と方法から「物質・容量・動作」を抽出し、実験フローを理解する。
4. **ペルソナ展開**:
   - **ベテラン視点**: [重点指示]を踏まえ、原理・専門用語を含むクエリを生成。
   - **新人視点**: [重点指示]を踏まえ、具体的な試薬名・手順を含むクエリを生成。
   - **マネージャー視点**: [重点指示]を踏まえ、全体プロセスの類似性を重視したクエリを生成。

# 出力形式
最終的な**3つの異なる検索クエリ文字列のみ**を、以下の厳密なJSON形式で出力してください。

{{
  "queries": [
    "ベテラン視点の検索クエリ文字列（重点指示を反映）",
    "新人視点の検索クエリ文字列（重点指示を反映）",
    "マネージャー視点の検索クエリ文字列（重点指示を反映）"
  ]
}}"""
    },

    # 後方互換性: 旧query_generationはcombined_query_generationへのエイリアス
    "query_generation": {
        "name": "クエリ生成ノード（後方互換）",
        "description": "多角的な検索クエリを生成（ベテラン/新人/マネージャー視点）- combined_query_generationへのエイリアス",
        "prompt": """# Role
あなたは生物・化学分野に精通したプロフェッショナルであり、高度な実験ノート検索エージェントです。

# Task
ユーザーの入力情報（目的、材料、方法、重点指示）を深く分析し、多様な視点から検索クエリを生成してください。

# Input Data
[目的] {input_purpose}
[材料(正規化済)] {normalized_materials}
[方法] {input_methods}
[重点指示] {user_focus_instruction}

# 重要な検索方針（必ず従うこと）

## 1. **重点指示を最優先**
[重点指示]が提供されている場合、この指示に従って検索クエリを生成してください。
重点指示は、ユーザーが最も重視する観点を示しています。

## 2. **目的が空の場合の特別ルール**
[目的]が空または「特になし」の場合：
- **材料（化学物質名、容量）と方法（化学物質、容量、手順）の記述が類似している実験ノートを最優先**してください。
- 具体的な物質名、容量、操作手順などのキーワードを重視してください。
- 意味的な類似性よりも、事実ベースの一致を重視してください。

## 3. **目的がある場合の方針**
[目的]が明確に記載されている場合：
- 目的の意図・背景を重視してください（Semantic Search向け）。
- ただし、[重点指示]がある場合は、その指示を優先してください。

# 思考プロセス（出力不要）
1. **重点指示の確認**: [重点指示]の内容を最優先で理解する。
2. **目的の有無を確認**: [目的]が空かどうかで検索戦略を切り替える。
   - 目的が空 → 材料・方法のキーワード一致を最重視
   - 目的がある → 意図・背景も考慮（ただし重点指示優先）
3. **構造化**: 材料と方法から「物質・容量・動作」を抽出し、実験フローを理解する。
4. **ペルソナ展開**:
   - **ベテラン視点**: [重点指示]を踏まえ、原理・専門用語を含むクエリを生成。
   - **新人視点**: [重点指示]を踏まえ、具体的な試薬名・手順を含むクエリを生成。
   - **マネージャー視点**: [重点指示]を踏まえ、全体プロセスの類似性を重視したクエリを生成。

# 出力形式
最終的な**3つの異なる検索クエリ文字列のみ**を、以下の厳密なJSON形式で出力してください。

{{
  "queries": [
    "ベテラン視点の検索クエリ文字列（重点指示を反映）",
    "新人視点の検索クエリ文字列（重点指示を反映）",
    "マネージャー視点の検索クエリ文字列（重点指示を反映）"
  ]
}}"""
    },

    "compare": {
        "name": "比較ノード",
        "description": "詳細な比較分析レポートを生成",
        "prompt": """あなたは優秀な研究アシスタントです。
以下の「ユーザーの実験計画」と「検索された過去の実験ノート」を詳細に比較してください。

# ユーザーの実験計画
[目的・背景] {input_purpose}
[材料(正規化済)] {normalized_materials}
[方法] {input_methods}
[重点指示] {user_focus_instruction}

# 検索された過去のノート
{retrieved_docs}

# 比較タスクのガイドライン
検索された各ノートについて、以下の観点で分析し、テーブルを作成してください。

1. **目的の比較 (Semantic Analysis)**:
   - 単語の一致ではなく、「研究の意図」「解決したい課題」「背景」が似ているかを**丁寧に**評価してください。
   - ユーザーの目的とノートの目的がどう関連しているか（例：同じ合成法だが対象が違う、目的は同じだがアプローチが違う等）を記述してください。

2. **材料・方法の比較 (Vector/Fact Analysis)**:
   - ここは**事実に基づいて厳密に**比較してください。
   - 物質名の表記揺れ（例：抗体Aと抗体a）は同一とみなして構いません。
   - 濃度や条件の違いがあれば具体的に指摘してください。

# 出力フォーマット (Markdown)

各ノートごとに以下の形式で出力してください。

## 実験ノート [ID] との比較

| 項目 | 入力計画 | 実験ノート [ID] | 分析・評価 |
| :--- | :--- | :--- | :--- |
| **目的・意図** | [入力の目的] | [ノートの目的] | **[ここを丁寧に記述]**<br>文脈や狙いの一致度、アプローチの差異について |
| **材料** | [主要な材料] | [主要な材料] | [一致・相違の具体的事実] |
| **方法・手順** | [主要な手順] | [主要な手順] | [条件・操作の差異] |

（重点指示がある場合、その観点での評価も「分析・評価」に含めてください）"""
    }
}

# 3軸検索用のプロンプトキー（UIで編集可能なもの）
MULTI_AXIS_PROMPT_KEYS = [
    "focus_classification",
    "material_query_generation",
    "method_query_generation",
    "combined_query_generation",
    "compare"
]

# 後方互換性のためのキーマッピング
PROMPT_KEY_ALIASES = {
    "query_generation": "combined_query_generation"
}


def get_default_prompt(prompt_type: str) -> str:
    """デフォルトプロンプトを取得

    Args:
        prompt_type: プロンプトタイプ

    Returns:
        プロンプト文字列
    """
    # エイリアスを解決
    resolved_type = PROMPT_KEY_ALIASES.get(prompt_type, prompt_type)

    if resolved_type in DEFAULT_PROMPTS:
        return DEFAULT_PROMPTS[resolved_type]["prompt"]
    return ""


def get_all_default_prompts() -> dict:
    """全デフォルトプロンプトを取得（UIで編集可能なもののみ）

    Returns:
        プロンプト辞書（normalizeとquery_generationエイリアスを除く）
    """
    result = {}
    for key in MULTI_AXIS_PROMPT_KEYS:
        if key in DEFAULT_PROMPTS:
            result[key] = DEFAULT_PROMPTS[key]
    return result


def merge_with_defaults(custom_prompts: dict) -> dict:
    """カスタムプロンプトとデフォルトをマージ（後方互換性対応）

    旧形式（query_generation, compare）から新形式への変換も行う。
    新しいキーがnullまたは存在しない場合はデフォルト値を使用。

    Args:
        custom_prompts: カスタムプロンプト辞書

    Returns:
        マージされたプロンプト辞書
    """
    result = {}

    for key in MULTI_AXIS_PROMPT_KEYS:
        # カスタムプロンプトに値があればそれを使用
        if key in custom_prompts and custom_prompts[key]:
            result[key] = custom_prompts[key]
        # 後方互換性: query_generationがあればcombined_query_generationとして使用
        elif key == "combined_query_generation" and "query_generation" in custom_prompts and custom_prompts["query_generation"]:
            result[key] = custom_prompts["query_generation"]
        # デフォルト値を使用
        else:
            result[key] = get_default_prompt(key)

    return result
