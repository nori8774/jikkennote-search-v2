# 要求内容

## 概要

検索コレクション構成を3コレクション（materials, methods, combined）から2コレクション（combined, materials_methods）に簡素化し、検索戦略を材料軸キーワード検索 + 方法・総合軸セマンティック検索に変更する。

## 背景

現在の実験ノートは以下の構造を持つ:
- **材料セクション**: `①HbA1c抗体 10mL`、`②NaOH 20mL` のように番号付き
- **方法セクション**: `①、②をビーカーに入れる` のように番号で省略

**現状の問題点**:
1. 材料と方法を別コレクションにすると、方法セクションだけでは「何の材料か」がわからない
2. 取り込み時にLLMで正規化（①→HbA1c抗体に展開）しているが、処理が複雑でコストがかかる
3. 人によって表記揺れがあり、正規化の精度に依存する

**提案解決策**:
- 材料+方法を結合したチャンクを作成することで、LLMが番号と材料名の対応を文脈から理解可能にする
- 取り込み時の正規化を廃止し、検索時にLLMが解釈する方式に変更

## 実装対象の機能

### 1. コレクション構成の変更

**Before**: 3コレクション
- `materials_collection_{team_id}` - 材料セクションのみ
- `methods_collection_{team_id}` - 方法セクションのみ
- `combined_collection_{team_id}` - ノート全体

**After**: 2コレクション
- `combined_collection_{team_id}` - ノート全体（総合軸）
- `materials_methods_collection_{team_id}` - 材料+方法セクションを結合（材料・方法軸）

### 2. 検索戦略の変更

| 軸 | コレクション | 検索方式 |
|----|-------------|---------|
| 材料軸 | materials_methods_collection | **キーワード検索（BM25）** |
| 方法軸 | materials_methods_collection | **セマンティック検索（ベクトル）** |
| 総合軸 | combined_collection | **セマンティック検索（ベクトル）** |

### 3. 取り込み処理の簡素化

- 省略形展開処理（expand_shortcuts）を削除
- サフィックスマッピング処理（suffix_conventions）を削除
- 辞書正規化は維持（名寄せ目的）
- 材料+方法結合チャンクの生成を追加

### 4. スコアブレンドとリランキング

1. 各軸で検索を実行
2. 結果を比率を変えてブレンド（パラメータ化）
3. ブレンド後の候補にリランキング（Cohere Rerank）をかけて最終スコアを算出

## 受け入れ条件

### コレクション構成の変更
- [ ] `materials_methods_collection_{team_id}` コレクションが作成される
- [ ] 既存の `materials_collection` と `methods_collection` は使用しない
- [ ] ChromaDBリセット→再取り込みで新構成が適用される

### 検索戦略の変更
- [ ] 材料軸検索がBM25キーワード検索で動作する
- [ ] 方法軸検索がセマンティック検索で動作する
- [ ] 総合軸検索がセマンティック検索で動作する

### 取り込み処理の簡素化
- [ ] 省略形展開処理が削除されている
- [ ] サフィックスマッピング処理が削除されている
- [ ] 材料+方法結合チャンクが正しく生成される

### スコアブレンドとリランキング
- [ ] ブレンド比率がパラメータとして設定可能
- [ ] リランキングが統合後に実行される
- [ ] 最終スコアで上位3件（評価モードでは10件）が返却される

## 成功指標

- 取り込み処理時間が短縮される（LLM呼び出しの削減）
- 検索精度が維持または向上する（評価機能で測定）
- コードの複雑性が低下する（行数・関数数の削減）

## スコープ外

以下はこのフェーズでは実装しません:

- フロントエンドUIでのブレンド比率調整機能（評価機能での検証のみ）
- 旧コレクションからの自動マイグレーション（手動リセット→再取り込みで対応）
- 辞書正規化の廃止（引き続き名寄せ目的で使用）

## 参照ドキュメント

- `docs/ideas/brainstorm-2026-01-07.md` - ブレインストーミング記録
- `docs/architecture.md` - アーキテクチャ設計書
- `docs/api-specification.md` - API仕様書
