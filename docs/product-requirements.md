# 要求仕様書 - 実験ノート検索システム v3.0

## 1. プロジェクト概要

### 1.1 目的
実験ノートの効率的な検索・再利用を実現し、研究開発の生産性を向上させる。
**v3.0では、実運用を想定したマルチテナント対応とユーザビリティの大幅改善を実現する。**

### 1.2 対象ユーザー

#### 主要ペルソナ

**ペルソナ1: 化学系研究者（IT初級レベル）**
- **年齢**: 30-45歳
- **IT習熟度**: ブラウザ操作、Excelは可能。コマンドライン、GCS等は不慣れ
- **課題**: 過去の実験ノートを探すのに毎回30分かかる。失敗の原因を特定できず同じミスを繰り返す
- **期待**: ブラウザ上のファイルアップロードだけで検索可能に。過去の失敗事例を5分で発見
- **利用頻度**: 週2-3回（新規実験計画時、失敗時）

**ペルソナ2: プロジェクトマネージャー（IT中級レベル）**
- **年齢**: 35-50歳
- **IT習熟度**: 基本的なツールは使える。API、GCS等の知識はある
- **課題**: チーム内の知見が属人化、共有されていない。週次レポート作成に5時間かかる
- **期待**: チーム全体のノートを横断検索、評価機能で精度検証、CSV出力で報告資料作成
- **利用頻度**: 週1回（週次レポート作成時）

#### 前提スキル
- **必須**: ブラウザ操作、ファイルアップロード、基本的な検索
- **推奨**: OpenAI/CohereのAPIキー取得（チュートリアル動画提供）
- **不要**: コマンドライン、Docker、GCS、プログラミング

#### 利用シーン
1. **新規実験の計画時**: 過去の類似実験を検索し、材料・方法を参考にする
2. **失敗時のトラブルシューティング**: 過去の失敗事例を検索し、原因を特定
3. **週次レポート作成時**: チーム全体の実験履歴を横断検索し、進捗を可視化
4. **新人教育時**: ベテランの実験ノートを検索し、ベストプラクティスを学習

### 1.3 前提システム
- **ベースシステム**: jikkennote-search v2.0
- **コア技術**: LangChain + LangGraph + ChromaDB + Cohere Reranking
- **新規追加技術**: Firebase Authentication, Sudachi（形態素解析）

### 1.4 ステークホルダーの期待

#### 研究者（実験担当者）
- **期待**: 過去の実験を5分以内に再発見、失敗の再発防止
- **懸念**: IT知識不足でノート取り込みに失敗しないか
- **成功基準**: チュートリアル動画（5分）を見れば90%の研究者が自力でノート取り込み可能

#### プロジェクトマネージャー
- **期待**: チーム全体の知見の可視化、進捗管理、週次レポート作成の効率化
- **懸念**: 検索精度が低く、使われなくなるリスク
- **成功基準**: nDCG@5 ≥ 0.85、週次レポート作成時間を50%削減（5時間→2.5時間）

#### 経営層
- **期待**: 研究開発のROI向上、属人化の解消、組織の知的資産の可視化
- **懸念**: APIコストの増大
- **成功基準**: ユーザー個別のAPIキーで運用、月間コストを可視化

### 1.5 v2.0の課題とv3.0での改善

#### v2.0で発生した課題
1. **シングルテナント構成**: 複数チームでの利用ができず、データが混在するリスク
2. **GCS直接配置の難易度**: IT非専門者がノートをアップロードできない
3. **検索精度の課題**: 一部フィールドを「なし」にした際にヒット精度が低下
4. **要約生成の遅延**: gpt-4oでの要約生成に30秒かかり、ユーザー体験が悪化

#### v3.0での改善
1. **マルチテナント対応**: チームごとにデータを完全分離、複数チームでの利用可能（FR-109）
2. **ノート取り込み改善**: ブラウザ上のファイルアップロード、Google Drive連携（FR-110）
3. **ハイブリッド検索**: セマンティック + キーワード検索で精度向上（FR-116）
4. **モデル2段階選択**: 要約生成にgpt-3.5-turboを使用し、10秒に短縮（FR-112）

---

## 2. 機能要件

### 2.1 コア検索機能（既存）

#### FR-001: 多角的クエリ生成
- **概要**: ユーザーの検索意図を「ベテラン」「新人」「マネージャー」の3視点でクエリ化
- **入力**: 目的、材料、実験手法、重点指示（任意）
- **出力**: 3つの視点から生成された検索クエリ

#### FR-002: 材料名正規化
- **概要**: 表記揺れを統一して検索精度を向上
- **処理**: マスター辞書（YAML）による自動正規化
- **例**: "EtOH" → "エタノール"

#### FR-003: ベクトル検索 + Reranking
- **概要**: OpenAI EmbeddingsでベクトルDB検索、Cohere APIで再ランキング
- **パラメータ**: Embeddingモデル、LLMモデルをユーザー選択可能
- **出力**: 関連度の高い実験ノート上位10件

#### FR-004: 比較分析レポート生成
- **概要**: 検索結果から上位3件を比較分析
- **出力**: Markdown形式の詳細レポート

### 2.2 新機能

#### FR-101: プロンプト管理機能
- **要件**: ハードコードされたプロンプトをUI上で編集・保存
- **保存方式**: YAMLファイル（最大50件）
- **機能**:
  - プロンプトの作成・編集・削除
  - 名前・説明付きで保存
  - 過去のプロンプトの呼び出し
  - 初期設定へのリセット

#### FR-102: 検索結果コピー機能
- **要件**: 上位3件の材料・方法をワンクリックで検索条件に反映
- **動作**: コピーボタン → 入力欄に自動挿入
- **フォーマット**: Markdown形式を維持

#### FR-103: 検索履歴管理
- **要件**: 検索クエリと結果を履歴として保存・再利用
- **保存内容**:
  - 検索クエリ（目的・材料・方法・重点指示）
  - 検索日時
  - 上位10件のノートID + スコア
  - 使用したプロンプト名
- **表示**: テーブル形式、ソート・フィルタリング可能
- **再利用**: クリックで過去の検索を復元

#### FR-104: 実験ノート直接閲覧機能
- **要件**: ノートIDを入力して全文を表示
- **機能**:
  - セクション別表示（目的・材料・方法）
  - 各セクションのコピーボタン
  - 検索条件への反映
- **注**: テストデータセットには結果セクションが含まれていないため、目的・材料・方法のみ表示

#### FR-105: モデル選択UI
- **要件**: Embedding/LLMモデルをUI上で選択（FR-112のモデル2段階選択に対応）
- **選択肢**:
  - **Embeddingモデル**: text-embedding-3-small, text-embedding-3-large, ada-002
  - **検索・判定用LLM**（正規化、クエリ生成、検索）: gpt-4o, gpt-4o-mini, gpt-5, gpt-5.1, gpt-5.2
  - **要約生成用LLM**（比較ノード）: gpt-3.5-turbo（デフォルト）, gpt-4o-mini, gpt-4o
- **説明**: 各モデルのコスト・性能・速度を表示
- **整合性**: FR-112（モデル2段階選択）と同じモデルリストを使用

#### FR-106: RAG性能評価機能
- **要件**: 事前定義したテストケースで検索精度を測定し、プロンプト・モデル最適化のための試行錯誤を支援
- **評価指標**:
  - **nDCG@5, nDCG@10**: 性能指標としては@5を重視（@10のランキング下位は似たようなノートが多く区別困難）
  - **Precision@5, Precision@10**: 上位K件に正解がどれだけ含まれるか
  - **Recall@10**: 全正解ノートのうち上位10件に何件含まれるか
  - **MRR**: 最初の正解ノートの順位の逆数
- **データセットの特性**:
  - テストケース数: 10件（正解ノート各10件）
  - 実験ノートの特性: 材料の容量違い、触媒違い、温度違いなど、似たようなノートが多数含まれる
  - @10のランキング下位: どれがヒットしてもおかしくない状態になる
  - 評価戦略: @10で全体的な精度を確認しつつ、@5のスコアを重視して最適化
- **テストケース管理**:
  - Excel/CSVからインポート
  - 手動作成・編集
  - 正解ランキングとの比較
- **試行錯誤ワークフロー**:
  1. プロンプトを編集（設定ページ）
  2. モデルを変更（Embedding/LLM）
  3. 評価実行 → nDCG@5, Precision@5を確認
  4. CSV出力 → 各評価履歴を比較
  5. 最良の設定を本番採用
- **結果表示**: グラフ、比較テーブル、CSV出力

#### FR-107: 新出単語抽出と正規化辞書管理
- **要件**: ノート取り込み時に未知の化学物質名を自動検出
- **判定支援**: LLMで類似単語を検索、表記揺れか新規物質かを判定
- **辞書更新**: ユーザー確認後に自動更新
- **管理UI**: 辞書の閲覧・編集・エクスポート/インポート

#### FR-108: ChromaDB管理機能
- **要件**: Embeddingモデル変更時の互換性問題を防止
- **機能**:
  - 現在のEmbeddingモデル表示
  - モデル変更時の警告表示
  - ChromaDBリセット機能
  - 設定履歴の記録

### 2.3 v3.0 新機能 ⭐

#### FR-109: マルチテナント対応
- **要件**: 複数チームが同じアプリを独立して使用可能
- **認証**: Googleログイン（Firebase Authentication）
- **チーム管理**:
  - ユーザーは複数チームに所属可能
  - 招待コードによるチーム参加
  - チームごとに独立したデータ（ノート、辞書、ChromaDB）
- **権限**: PoC仕様として全メンバー同等の編集権限
- **データ分離**: チーム間で完全にデータを分離
- **エッジケース**:
  - **チーム脱退時**: ユーザーは他のチームに所属している場合のみ脱退可能。最後のチームからは脱退不可（チーム削除を推奨）
  - **チーム削除時**: チーム内の全データ（ノート、辞書、ChromaDB）を削除。削除前に警告メッセージ表示（「削除すると復旧できません。本当に削除しますか？」）
  - **招待コード有効期限**: 7日間。期限切れのコードは無効化され、再発行が必要

#### FR-110: ノート取り込み改善（非IT向け）
- **要件**: IT非専門者でも簡単にノートをアップロード
- **取り込み方法**:
  - ローカルファイルアップロード（優先）
  - Google Drive連携
  - GCS方式は廃止（ハードルが高い）
- **アーカイブ方式**: 取り込み済みノートを`processed/`に保存（削除しない）
- **Embeddingモデル変更時の対応**:
  - 既存機能: ChromaDBをリセットし、全ノートのEmbeddingを再生成してDB再構築（FR-108）
  - 再取り込み: `processed/`フォルダから過去のノートを再取り込み可能

#### FR-111: 辞書自動抽出（Sudachi + LLM）
- **要件**: ノート取り込み時に化学物質名・作業名を自動抽出
- **判定ロジック**:
  - Sudachi形態素解析で単語抽出
  - LLMで複合語 vs 表記揺れを判定
  - ユーザー確認UIで最終決定
- **複合語の扱い**: 「抗原」「抗体」「抗原抗体反応」を別の用語として共存
- **表記揺れの扱い**: 「こうげんこうたい反応」→「抗原抗体反応」として名寄せ
- **辞書更新**: ユーザー承認後に自動反映

#### FR-112: モデル2段階選択
- **要件**: 検索・判定と要約生成で異なるモデルを選択可能
- **検索・判定用LLM**（正規化、クエリ生成、検索）:
  - gpt-4o-mini（デフォルト）
  - gpt-4o
  - gpt-4.5-preview ⭐ 新規
  - o1 ⭐ 新規
  - o1-mini ⭐ 新規
  - o3-mini ⭐ 新規
- **要約生成用LLM**（比較ノード）:
  - gpt-4o-mini（デフォルト、高速）
  - gpt-4o
  - gpt-4.5-preview
  - o1-mini
  - o3-mini
- **効果**: 要約生成の速度向上（30秒 → 10秒目標）

#### FR-113: 再検索機能
- **要件**: 検索結果を確認後、重点指示を追加して再検索
- **UI配置**: 検索結果画面の右上に「重点指示を追加して再検索」ボタン
- **ワークフロー**:
  1. 初回検索実行（目的・材料・方法） → 結果表示
  2. ユーザーが「重点指示を追加して再検索」ボタンをクリック
  3. モーダル表示: 重点指示入力欄（プレースホルダー: 「例: 材料の量に注目して検索してください」）
  4. 「再検索」ボタン → 目的・材料・方法はそのまま、重点指示のみ追加
  5. 結果を同じ画面に再表示（履歴に両方の検索を保存）
- **モバイル対応**: ボタンは画面下部に固定表示

#### FR-114: コピー機能強化
- **ビューワー画面**:
  - **UI配置**: 各セクション（目的・材料・方法）の右上に「検索条件として一括コピー」ボタン
  - **動作**: 目的・材料・方法をlocalStorageに保存 → 検索ページに遷移 → 自動入力
  - **フィードバック**: コピー成功時にトースト通知「検索ページに遷移します」
- **検索画面（検索結果リスト）**:
  - **UI配置**: 各ノートカードに4つのボタン: [目的] [材料] [方法] [一括]
  - **ボタンサイズ**: 小サイズ、アイコン付き（コピーアイコン）
  - **動作**: クリック → 左側フォームに即座に反映
  - **フィードバック**: コピー成功時にボタンが一瞬グリーンに変化
  - **モバイル対応**: 横スクロール可能なボタングループ

#### FR-115: 評価機能改善
- **CSV出力**:
  - カラム: 条件ID, Embeddingモデル, LLMモデル, プロンプト名, nDCG@5, nDCG@10, Precision@5, Precision@10, Recall@10, MRR, 正解1〜10_検出ランク
  - 各評価履歴にエクスポートボタン
  - **@5と@10の両方を出力**: 主要指標のnDCG@5, Precision@5と参考指標のnDCG@10, Precision@10を同時に確認可能
- **UI改善**:
  - デバッグ表示（入力条件）削除
  - 評価履歴保存件数: 5件 → 50件

#### FR-116: ハイブリッド検索 ⭐ 重要
- **背景**:
  - 現在のセマンティック検索では、一部フィールドを「なし」にした際にヒット精度が低下
  - **検索入力フィールド**: 目的、材料、方法、重点指示（任意）の4項目
  - **各フィールドの特性と最適な検索方式**:
    - **目的**: 文章 → セマンティック検索が適切
    - **重点指示**: 文章 → セマンティック検索が適切
    - **材料**: 化学物質名（固有名詞）、容量（数値） → キーワード検索が適切
    - **方法**: 実験手順の並び → キーワードの並びをセマンティックに検索
  - プロンプト改良だけでは根本的解決が困難
- **要件**: 検索対象の特性に応じて最適な検索手法を選択可能に
- **検索モード**:
  - **セマンティック検索**（デフォルト）: Embedding + ChromaDB、文章の意味的類似性で検索
  - **キーワード検索**: BM25トークンベース検索、固有名詞・専門用語に強い
  - **ハイブリッド検索**（推奨）: セマンティック + キーワードの組み合わせ、最も精度が高い
- **UI**:
  - 検索画面に検索モード選択ドロップダウン追加
  - 設定画面でハイブリッド検索の重み調整（セマンティック: 0.7, キーワード: 0.3がデフォルト）
- **API**:
  - `/search` に `search_mode` パラメータ追加（"semantic" | "keyword" | "hybrid"）
  - `hybrid_alpha` パラメータ追加（0.0〜1.0、セマンティックの重み）
- **期待効果**:
  - 部分検索（一部フィールド「なし」）での精度向上
  - 材料名・方法などキーワード重視の検索精度改善
  - ユーザーが検索対象に応じて最適モードを選択可能

---

## 3. 非機能要件

### 3.1 性能要件
- **NFR-001**: 検索レスポンス時間 < 5秒
- **NFR-002**: 新出単語抽出 < 10秒/ノート
- **NFR-003**: 増分DB更新（既存ノートスキップ）
- **NFR-004**: 要約生成時間 < 10秒（v3.0新規、モデル2段階選択による）

### 3.2 セキュリティ要件
- **NFR-101**: APIキーはユーザーがブラウザで入力（localStorage保存）
- **NFR-102**: サーバー側でAPIキーを保存しない
- **NFR-103**: HTTPS通信のみ
- **NFR-104**: Googleログインによる認証（Firebase Authentication）
- **NFR-105**: チーム間のデータ完全分離（他チームのデータにアクセス不可）

### 3.3 ユーザビリティ要件
- **NFR-201**: 既存UIデザインとの統一性
- **NFR-202**: レスポンシブ対応（モバイル・タブレット）
- **NFR-203**: エラーメッセージの日本語化
- **NFR-204**: IT非専門者でも使いやすいファイルアップロードUI
- **NFR-205**: GCS等の専門知識を不要にする

### 3.4 運用要件
- **NFR-301**: Vercelでのフロントエンドデプロイ
- **NFR-302**: Google Cloud Runでのバックエンドデプロイ
- **NFR-303**: Google Cloud Storageでのデータ管理（チームごとに分離）

### 3.5 拡張性要件
- **NFR-401**: 10,000件のノートまでスケーラブル（検索レスポンス < 5秒維持）
- **NFR-402**: 同時アクセス数: 最大10ユーザー（Cloud Run concurrency設定による）
- **NFR-403**: チーム数: 最大100チーム（GCSバケットのフォルダ数制限に依存）

### 3.6 保守性要件
- **NFR-501**: バックエンドのテストカバレッジ: 80%以上（pytest）
- **NFR-502**: フロントエンドのE2Eテストカバレッジ: 主要フローを100%カバー（Playwright）
- **NFR-503**: ドキュメントの最新性: コード変更時に関連ドキュメントも更新（CLAUDE.md、docs/等）

---

## 4. 制約条件

### 4.1 技術制約
- Next.js 15 App Router使用
- Python 3.12+
- OpenAI API / Cohere API依存
- Firebase Authentication（Googleログイン）
- Sudachi形態素解析器（辞書自動抽出）

### 4.2 データ制約
- **実験ノート**: Markdown形式
- **ベクトルDB**: ChromaDB（GCS永続化、チームごとに分離）
- **プロンプト保存上限**: 50件
- **評価履歴保存上限**: 50件（v3.0で5件から拡大）
- **データ構造**: `teams/{team_id}/`配下に全データを分離

### 4.3 コスト制約
- ユーザー自身のAPIキーを使用（コスト分散）

---

## 5. 成功指標（KPI）

### 5.1 機能完成度
- [ ] v2.0全機能（FR-001〜FR-108）が実装され動作する
- [ ] v3.0全機能（FR-109〜FR-115）が実装され動作する

### 5.2 検索精度
- [ ] **nDCG@5 ≥ 0.85**（主要指標）
  - **測定方法**: 10件のテストケース（各正解ノート10件）で評価
  - **データセット特性**: 材料の容量違い、触媒違い、温度違いなど、似たようなノートが多数含まれる
  - **評価戦略**: @10で全体的な精度を確認しつつ、@5のスコアを重視して最適化
  - **根拠**: 実験ノートの特性上、上位5件に正解が含まれることが実用上重要
- [ ] **Precision@5 ≥ 0.8**
  - **測定方法**: 上位5件に正解がいくつ含まれるか（10件のテストケースの平均）
- [ ] **nDCG@10 ≥ 0.8**（参考指標）
  - ランキング下位はどれがヒットしてもおかしくない状態になるため、参考値として確認

### 5.3 ユーザビリティ
- [ ] 複数チームでの利用実績（最低3チーム）
- [ ] IT非専門者の自力ノート取り込み成功率 ≥ 90%
  - **測定方法**:
    - 5人のIT初級レベル研究者に、チュートリアル動画（5分）を見せた後、10件のノートをアップロードさせる
    - 成功基準: ChromaDBに正しくノートが追加され、検索結果に反映されること
    - 評価時期: v3.0リリース前のユーザーテスト

### 5.4 パフォーマンス
- [ ] 検索レスポンス < 5秒
  - **測定方法**: 10件のテストケースで検索を実行し、平均レスポンスタイムを測定
  - **根拠**: v2.0の実測値は3-7秒。ハイブリッド検索で+1秒を見込み、5秒を目標
- [ ] 要約生成 < 10秒（v3.0目標）
  - **測定方法**: 比較ノードの実行時間を測定（summary_llm_model=gpt-3.5-turbo）
  - **根拠**: v2.0（gpt-4o）では30秒。gpt-3.5-turboで3倍高速化を期待
- [ ] ノート取り込み作業の自動化率 > 80%
  - **測定方法**: 新出単語の自動判定精度（人手による修正率 < 20%）

### 5.5 ビジネスインパクト（将来的に測定）
- [ ] 1実験あたりの検索時間: 30分 → 5分（83%削減）
- [ ] 月間のOpenAI/Cohere APIコスト: ユーザー負担（コスト分散達成）
- [ ] 過去の失敗事例の再検索率: > 50%（失敗の再発防止）

---

## 6. リスクと対応策

| リスク | 影響 | 対応策 |
|--------|------|--------|
| Embeddingモデル変更時のDB互換性喪失 | 高 | ✅ FR-108で対応済み（警告+リセット機能） |
| APIコスト増大 | 中 | ユーザー個別のAPIキー使用 |
| 大量ノート時の検索速度低下 | 中 | インデックス最適化、ページネーション |
| チーム間データ漏洩 | 高 | GCSバケットポリシー、アプリ層での厳格な分離 |
| Sudachi辞書の専門用語対応不足 | 中 | カスタム辞書追加、LLM補完 |
| Firebase無料枠超過 | 低 | 使用量モニタリング、必要に応じて有料プラン |
| マルチテナント化による複雑性増大 | 中 | PoC仕様で機能を最小限に、段階的実装 |

---

## 7. 用語集

| 用語 | 説明 |
|------|------|
| Embedding | テキストをベクトル表現に変換するモデル |
| Reranking | 検索結果を関連度順に並べ替える処理 |
| nDCG@10 | 上位10件の検索精度を測る評価指標 |
| 正規化 | 表記揺れを統一する処理 |
| 増分更新 | 既存データをスキップして新規データのみ処理 |
| マルチテナント | 複数のチーム（テナント）が同じアプリを独立して使用する構成 |
| Sudachi | 日本語形態素解析器。複合語の分割・結合に対応 |
| 複合語 | 「抗原抗体反応」のように、複数の単語が組み合わさった用語 |
| 表記揺れ | 「エタノール」「EtOH」「エチルアルコール」など同じ物質の異なる表記 |
| セマンティック検索 | Embeddingによる意味的類似性に基づく検索。文章に強い |
| キーワード検索 | BM25などのトークンベース検索。固有名詞・専門用語に強い |
| ハイブリッド検索 | セマンティック検索とキーワード検索を組み合わせた検索手法 |
| BM25 | トークンの出現頻度と文書の長さを考慮したキーワード検索アルゴリズム |

---

**作成日**: 2025-12-25
**最終更新**: 2025-12-30
**バージョン**: 3.0.2 (PRD詳細化: ペルソナ定義、nDCG@5重視、エッジケース、拡張性・保守性要件を追加)
