# E2Eテスト: データ分離の確認

マルチテナント機能が正しくデータを分離していることを確認します。

## 前提条件

- ✅ バックエンドサーバーが起動している (http://localhost:8000)
- ✅ フロントエンドが起動している (http://localhost:3000)
- ✅ Firebaseログインが可能

## テスト手順

### ステップ1: チームAの作成とノート取り込み

1. **ブラウザでアクセス**: http://localhost:3000
2. **ログイン**: Googleアカウントでログイン
3. **チーム管理ページに移動**: 右上の「チーム管理」をクリック
4. **チームAを作成**:
   - チーム名: `テストチームA`
   - 説明: `データ分離テスト用チームA`
   - 「チームを作成」をクリック
   - 📋 **招待コードをメモ**: `XXX-XXX-XXX`
5. **ヘッダーでチームAを選択**: 右上のドロップダウンで「テストチームA」を選択
6. **ノート管理ページに移動**: 左側メニューの「ノート管理」をクリック
7. **ファイルアップロード**:
   - 📤 ファイルアップロードセクションで「ファイルを選択」
   - `backend/test_team_a.md` を選択
   - アップロード成功メッセージを確認
8. **ノート取り込み実行**:
   - 「取り込み実行」ボタンをクリック
   - 新出単語分析はスキップ（「キャンセル」）
   - ✅ 「1件の新規ノートを追加しました」を確認

### ステップ2: チームBの作成とノート取り込み（別ブラウザまたはシークレットモード）

**オプション1: 別のGoogleアカウントを使用する場合**
1. シークレットウィンドウで http://localhost:3000 を開く
2. 別のGoogleアカウントでログイン

**オプション2: 同じアカウントで別チームを作成する場合**
1. 通常のウィンドウのまま続行（推奨）

**チームBの作成:**
1. **チーム管理ページに移動**
2. **チームBを作成**:
   - チーム名: `テストチームB`
   - 説明: `データ分離テスト用チームB`
   - 「チームを作成」をクリック
3. **ヘッダーでチームBを選択**: 右上のドロップダウンで「テストチームB」を選択
4. **ノート管理ページに移動**
5. **ファイルアップロード**:
   - `backend/test_team_b.md` を選択
   - アップロード成功メッセージを確認
6. **ノート取り込み実行**:
   - 「取り込み実行」ボタンをクリック
   - 新出単語分析はスキップ
   - ✅ 「1件の新規ノートを追加しました」を確認

### ステップ3: データ分離の確認

#### 3-1. チームAでの検索テスト

1. **ヘッダーでチームAを選択**
2. **検索ページに移動**: 左側メニューの「検索」をクリック
3. **検索条件を入力**:
   - 目的・背景: `データ分離`
   - 材料: `エタノール 蒸留水 試薬X`
   - 方法: `混合 静置`
4. **検索実行**
5. **結果確認**:
   - ✅ **ID-TEAM-A-001** が表示される
   - ❌ **ID-TEAM-B-001** は表示されない（重要！）
   - ✅ 「チームA専用試薬X」が検索結果に含まれる
   - ❌ 「チームB専用試薬Y」や「メタノール」は含まれない

#### 3-2. チームBでの検索テスト

1. **ヘッダーでチームBを選択**
2. **検索ページで検索条件を入力**:
   - 目的・背景: `データ分離`
   - 材料: `メタノール 純水 試薬Y`
   - 方法: `混合 保管`
3. **検索実行**
4. **結果確認**:
   - ✅ **ID-TEAM-B-001** が表示される
   - ❌ **ID-TEAM-A-001** は表示されない（重要！）
   - ✅ 「チームB専用試薬Y」が検索結果に含まれる
   - ❌ 「チームA専用試薬X」や「エタノール」は含まれない

### ステップ4: ChromaDBコレクションの確認（バックエンドで確認）

ターミナルで以下のコマンドを実行:

```bash
cd /Users/nori8774/jikkennote-search_v1/backend
python check_chroma_collections.py
```

**期待される出力例**:
```
======================================================================
ChromaDB コレクション確認
======================================================================

見つかったコレクション数: 2

チームID: u5mgoe8cJLZ5Mw8bQgmw
  コレクション名: notes_u5mgoe8cJLZ5Mw8bQgmw
  ドキュメント数: 1
  パス: teams/u5mgoe8cJLZ5Mw8bQgmw/chroma-db

チームID: xyz123abc456def789
  コレクション名: notes_xyz123abc456def789
  ドキュメント数: 1
  パス: teams/xyz123abc456def789/chroma-db

----------------------------------------------------------------------
チーム別ドキュメント数:
  u5mgoe8cJLZ5Mw8bQgmw: 1件
  xyz123abc456def789: 1件
----------------------------------------------------------------------
```

**確認ポイント**:
- ✅ 各チームごとに独立したコレクションが作成されている
- ✅ コレクション名が `notes_{team_id}` 形式になっている
- ✅ 各コレクションに1件ずつドキュメントが格納されている
- ✅ パスが `teams/{team_id}/chroma-db` になっている

## テスト結果判定

### ✅ 成功（全て満たす必要がある）

- [ ] チームAの検索でチームAのノートのみが表示される
- [ ] チームBの検索でチームBのノートのみが表示される
- [ ] チームAの検索結果にチームBのノートが含まれない
- [ ] チームBの検索結果にチームAのノートが含まれない
- [ ] ChromaDBコレクションがチーム別に分離されている
- [ ] 各チームのデータが正しいパスに保存されている

### ❌ 失敗（以下のいずれかが発生）

- チームAの検索でチームBのノートが表示される
- チームBの検索でチームAのノートが表示される
- ChromaDBコレクションが共有されている
- エラーが発生する

## トラブルシューティング

### 検索結果に何も表示されない場合

1. ノートが正しく取り込まれたか確認
   - ノート管理ページの「取り込み結果」セクションを確認
   - 「新規取り込み (1件)」と表示されているか

2. ChromaDBコレクションが作成されているか確認
   - `python check_chroma_collections.py` を実行
   - ドキュメント数が0でないか確認

3. APIキーが正しく設定されているか確認
   - 設定ページでOpenAI APIキーを確認
   - Cohere APIキーを確認

### 他のチームのノートが表示される場合

1. ヘッダーで正しいチームが選択されているか確認
2. ブラウザのキャッシュをクリア（Cmd+Shift+R）
3. バックエンドサーバーを再起動

## クリーンアップ（テスト後）

テストが完了したら、以下でテストデータをクリーンアップできます:

```bash
# テスト用ノートファイルを削除
rm -f backend/test_team_a.md
rm -f backend/test_team_b.md

# テストチームのデータを削除（オプション）
# 注意: チームIDは実際の値に置き換えてください
rm -rf teams/[team_a_id]
rm -rf teams/[team_b_id]
```

または、チーム管理ページから「チームを削除」で削除できます（実装予定）。
