# 本番環境 初期セットアップ手順

## 現在の状態 ✅

### デプロイ完了
- ✅ **フロントエンド**: https://jikkennote-search.vercel.app
- ✅ **バックエンド**: https://jikkennote-backend-285071263188.asia-northeast1.run.app
- ✅ **ストレージ**: Google Cloud Storage (jikkennote-storage)
- ✅ **ノートデータ**: 340件のノートがGCSにアップロード済み

### 確認済み事項
- ✅ バックエンドのヘルスチェックが正常
- ✅ CORS設定が正しく動作
- ✅ フロントエンドが正常に表示
- ✅ バックエンドからGCSのノートを読み込める

---

## 初回セットアップ手順

### ステップ1: APIキーの設定

1. **フロントエンドにアクセス**
   ```
   https://jikkennote-search.vercel.app
   ```

2. **設定ページを開く**
   - 右上の「設定」をクリック
   - または直接: https://jikkennote-search.vercel.app/settings

3. **APIキータブを選択**
   - 「APIキー」タブをクリック

4. **APIキーを入力**
   - **OpenAI API Key**: `sk-proj-...` で始まるキーを入力
   - **Cohere API Key**: Cohereのダッシュボードから取得したキーを入力

5. **設定を保存**
   - 「設定を保存」ボタンをクリック
   - ブラウザのlocalStorageに保存されます

---

### ステップ2: ノートをChromaDBに取り込む

**重要**: 340件のノートを取り込むと、OpenAI APIの料金が発生します（推定: $1-3程度）

1. **ノート管理ページを開く**
   ```
   https://jikkennote-search.vercel.app/ingest
   ```

2. **取り込み設定**
   - **ソースフォルダ**: `notes/new` （デフォルト）
   - **取り込み後のアクション**: 「processed フォルダへ移動」を選択
   - **Embeddingモデル**: `text-embedding-3-small` （推奨・最安）
   - **再構築モード**: 初回は✅チェックを入れる

3. **取り込み実行**
   - 「取り込み実行」ボタンをクリック
   - 進捗状況が表示されます
   - **所要時間**: 約5-10分（340件の場合）

4. **完了確認**
   - 「〇〇件のノートを取り込みました」と表示されればOK
   - ノートは自動的に `notes/processed/` に移動されます

---

### ステップ3: 検索機能をテスト

1. **検索ページを開く**
   ```
   https://jikkennote-search.vercel.app/search
   ```

2. **テスト検索を実行**

   **例1: HbA1c測定に関する検索**
   ```
   目的: HbA1c測定試薬の性能評価
   材料: HbA1c捕捉抗体、ラテックス
   方法: 現行機種Xで測定
   ```

   **例2: 抗体の最適化**
   ```
   目的: 抗体濃度の最適化
   材料: モノクローナル抗体、HRP標識
   方法: 濃度を変えて感度を比較
   ```

3. **結果確認**
   - 上位3件の類似ノートが表示される
   - 比較分析レポートが生成される
   - 各ノートの「材料」「方法」をコピーボタンでコピー可能

---

### ステップ4: 履歴機能をテスト

1. **履歴ページを開く**
   ```
   https://jikkennote-search.vercel.app/history
   ```

2. **検索履歴を確認**
   - ステップ3で実行した検索が記録されている
   - ノートIDをクリックすると、ビューワーで全文表示
   - 「再検索」ボタンで同じ条件で再検索可能

---

### ステップ5: ノートビューワーをテスト

1. **ビューワーページを開く**
   ```
   https://jikkennote-search.vercel.app/viewer
   ```

2. **ノートIDを入力**
   ```
   例: ID1-1
   ```

3. **表示確認**
   - ノート全文がMarkdown形式で表示
   - 「目的」「材料」「方法」セクション別にコピーボタンあり

---

## 追加機能のセットアップ（オプション）

### 辞書管理

**正規化辞書をインポート**
1. 辞書管理ページを開く: `/dictionary`
2. 既存の辞書ファイル（YAML/JSON/CSV）をインポート
3. 表記揺れの統一により検索精度が向上

### 性能評価

**テストケースをインポート**
1. 性能評価ページを開く: `/evaluate`
2. ExcelまたはCSVファイルをインポート
3. nDCG、Precision、Recallなどの指標でRAG性能を測定

---

## トラブルシューティング

### 検索結果が返ってこない

**原因**: ChromaDBにデータが取り込まれていない

**解決策**:
1. ノート管理ページ（`/ingest`）でノートを取り込む
2. 再構築モードで取り込み直す

### APIキーエラーが表示される

**原因**: APIキーが無効または未設定

**解決策**:
1. 設定ページ（`/settings`）でAPIキーを再確認
2. OpenAI APIキーは `sk-proj-` で始まることを確認
3. APIキーの有効期限を確認

### CORS エラーが表示される

**原因**: バックエンドのCORS設定が正しくない

**解決策**:
```bash
# バックエンドのCORS設定を確認
gcloud run services describe jikkennote-backend \
    --region=asia-northeast1 \
    --project=jikkennote-search \
    --format="value(spec.template.spec.containers[0].env)" | grep CORS

# 正しいVercel URLが設定されているか確認
# 期待値: CORS_ORIGINS=https://jikkennote-search.vercel.app
```

### ノート取り込みが失敗する

**原因1**: OpenAI APIキーが無効

**解決策**: 設定ページで正しいAPIキーを設定

**原因2**: GCSバケットにアクセスできない

**解決策**: バックエンドのログを確認
```bash
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=jikkennote-backend" \
    --limit=50 \
    --project=jikkennote-search
```

---

## 料金の目安

### OpenAI API
- **Embedding (text-embedding-3-small)**: $0.02 / 1M tokens
- **340件のノート取り込み**: 約$0.50-1.00
- **検索1回あたり**: 約$0.01-0.03（LLM処理含む）

### Cohere API
- **Reranking**: $2.00 / 1M tokens
- **検索1回あたり**: 約$0.005-0.01

### Google Cloud
- **Cloud Run**: 従量課金（月間無料枠あり）
- **Cloud Storage**: $0.020 / GB / 月

**月間推定コスト**: $5-20（利用頻度により変動）

---

## 本番運用のベストプラクティス

### 1. 定期的なバックアップ
```bash
# ChromaDBをバックアップ
gsutil cp -r /tmp/chroma_db gs://jikkennote-storage/backups/chroma_db_$(date +%Y%m%d)

# 辞書ファイルをバックアップ
gsutil cp master_dictionary.yaml gs://jikkennote-storage/backups/dictionary_$(date +%Y%m%d).yaml
```

### 2. ログの監視
- Cloud Run のログを定期的に確認
- エラーが発生した場合は即座に対応

### 3. APIキーのローテーション
- 3-6ヶ月ごとにAPIキーを更新
- 古いキーを無効化

### 4. パフォーマンス最適化
- 検索履歴を分析して、よく検索されるパターンを把握
- プロンプトを調整して精度向上

---

## サポート

### ドキュメント
- **デプロイ手順**: DEPLOYMENT.md
- **ユーザーマニュアル**: USER_MANUAL.md
- **機能仕様**: CLAUDE.md

### 問題報告
GitHubのIssuesで報告してください:
```
https://github.com/nori8774/jikkennote-search/issues
```

---

## チェックリスト

初回セットアップ完了確認:

- [ ] フロントエンドにアクセスできる
- [ ] APIキーを設定した
- [ ] 340件のノートをChromaDBに取り込んだ
- [ ] 検索機能をテストした（結果が返ってくる）
- [ ] 履歴機能をテストした
- [ ] ノートビューワーをテストした
- [ ] すべての機能が正常に動作する

---

**最終更新日**: 2025-12-27
**バージョン**: 2.0.0
**デプロイ環境**: Vercel (Frontend) + Cloud Run (Backend) + GCS (Storage)
