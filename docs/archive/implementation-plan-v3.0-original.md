# v3.0 実装計画書

## 1. 実装戦略の概要

### 1.1 現状認識

**v2.0の状態**（2025-12-19完了）:
- コア検索機能（FR-001〜FR-004）: 実装済み
- プロンプト管理（FR-101）: 実装済み
- 検索結果コピー（FR-102）: 実装済み
- 検索履歴管理（FR-103）: 実装済み
- ノート閲覧機能（FR-104）: 実装済み
- モデル選択UI（FR-105）: 実装済み
- RAG性能評価（FR-106）: 実装済み
- 新出単語抽出・辞書管理（FR-107）: 実装済み
- ChromaDB管理（FR-108）: 実装済み

**v3.0で追加する機能**:
- FR-109: マルチテナント対応 ⭐ 最優先
- FR-110: ノート取り込み改善
- FR-111: 辞書自動抽出（Sudachi + LLM）
- FR-112: モデル2段階選択
- FR-113: 再検索機能
- FR-114: コピー機能強化
- FR-115: 評価機能改善
- FR-116: ハイブリッド検索 ⭐ 重要

### 1.2 実装方針

1. **依存関係を重視**: インフラ → コア機能 → UI改善の順
2. **リスクの早期解決**: 技術的に難しい機能を先に実装
3. **段階的価値提供**: 各フェーズで動作確認・デプロイ可能に
4. **テスト駆動**: 実装前にテストケース作成、実装後に自動テスト

### 1.3 フェーズ分け

| フェーズ | 期間目安 | 機能 | 目的 |
|---------|---------|------|------|
| **Phase 1** | 3-5日 | FR-109（マルチテナント） | 基盤整備 |
| **Phase 2** | 2-3日 | FR-112, FR-116 | コア検索強化 |
| **Phase 3** | 3-4日 | FR-110, FR-111 | ノート管理改善 |
| **Phase 4** | 2-3日 | FR-113, FR-114, FR-115 | UI/UX最終調整 |
| **Phase 5** | 1-2日 | 統合テスト・デプロイ | 品質保証 |

**総所要時間**: 11-17日（約2-3週間）

---

## 2. Phase 1: マルチテナント基盤整備

### 2.1 目的

複数チームが同じアプリを独立して使用できる基盤を構築。全機能の前提となるため最優先で実装。

### 2.2 実装内容

#### 2.2.1 Firebase Authentication統合
- **Frontend**:
  - Googleログイン機能（Firebase SDK）
  - 認証状態管理（Context API）
  - ログイン/ログアウトUI
- **Backend**:
  - Firebase Admin SDKでID Token検証
  - `/auth/verify` エンドポイント作成

#### 2.2.2 チーム管理機能
- **Backend API**:
  - `POST /teams/create`: チーム作成
  - `GET /teams`: ユーザーが所属するチーム一覧
  - `POST /teams/join`: 招待コード参加
  - `DELETE /teams/{team_id}`: チーム削除
  - `POST /teams/{team_id}/leave`: チーム脱退
- **Database**:
  - Firestore: teams, team_members コレクション
- **Frontend**:
  - チーム選択UI（ヘッダー）
  - チーム作成・招待・管理ページ

#### 2.2.3 GCSマルチテナント対応
- **ストレージ構造変更**:
  ```
  gs://jikkennote-storage/
  └── teams/
      └── {team_id}/
          ├── chroma-db/
          ├── notes/
          │   ├── new/
          │   └── processed/
          ├── saved_prompts/
          └── dictionary.yaml
  ```
- **Backend修正**:
  - `storage.py`: チームIDに基づくパス生成
  - 全エンドポイントで`X-Team-ID`ヘッダー検証
  - ChromaDB: チームごとに独立したコレクション

### 2.3 実装手順

#### Step 1: Firebase設定（0.5日）
1. Firebase Consoleでプロジェクト作成
2. Google認証プロバイダー有効化
3. `firebase-config.json`をフロントエンドに配置
4. Firebase Admin SDKをバックエンドに設定

#### Step 2: 認証機能実装（1日）
1. フロントエンド:
   - `app/login/page.tsx`: ログインページ
   - `lib/auth-context.tsx`: 認証状態管理
   - `components/Header.tsx`: ログイン状態表示
2. バックエンド:
   - `auth.py`: Firebase ID Token検証関数
   - ミドルウェア: 全エンドポイントで認証チェック

#### Step 3: チーム管理API（1.5日）
1. Firestoreスキーマ設計
2. `backend/teams.py`: チーム管理ロジック
3. `server.py`: チーム関連エンドポイント追加
4. テスト: チーム作成→招待→参加→脱退のフロー

#### Step 4: GCSマルチテナント対応（1日）
1. `storage.py`を`get_team_path(team_id, resource_type)`に変更
2. 全ファイル操作をチームスコープに変更
3. ChromaDB: `collection_name=f"notes_{team_id}"`
4. 既存データ移行スクリプト作成

#### Step 5: フロントエンド統合（1日）
1. チーム選択UI（ヘッダー）
2. チーム管理ページ（`app/teams/page.tsx`）
3. 全APIリクエストに`X-Team-ID`ヘッダー追加
4. localStorage: 選択中のチームID保存

### 2.4 成功基準

- [ ] 複数ユーザーでログイン・ログアウト可能
- [ ] チーム作成・招待コード発行・参加が可能
- [ ] チームAのユーザーがチームBのデータにアクセスできない
- [ ] 既存のノート検索機能がチームスコープで動作
- [ ] E2Eテスト: マルチテナントシナリオ（2チーム、各2ユーザー）

### 2.5 リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| Firebase無料枠超過 | 中 | 使用量モニタリング、認証回数制限 |
| GCS移行時のデータ損失 | 高 | バックアップ取得、段階的移行、ロールバック手順 |
| 認証トークン漏洩 | 高 | HTTPS必須、短いトークン有効期限、リフレッシュトークン実装 |
| チーム削除の誤操作 | 中 | 削除前に確認ダイアログ、削除後30日間の猶予期間（将来実装） |

### 2.6 テスト計画

**単体テスト**:
- `auth.py`: Firebase ID Token検証
- `teams.py`: チームCRUD操作
- `storage.py`: チームスコープのパス生成

**E2Eテスト**:
- ユーザーA（チーム1）とユーザーB（チーム2）が独立して動作
- チーム1のノートがチーム2の検索結果に表示されない
- チーム切り替え時にデータが正しく切り替わる

---

## 3. Phase 2: コア検索機能強化

### 3.1 目的

検索精度とパフォーマンスを向上させる。FR-112（モデル2段階選択）とFR-116（ハイブリッド検索）を実装。

### 3.2 実装内容

#### 3.2.1 FR-112: モデル2段階選択

**背景**: v2.0では要約生成にgpt-4oを使用し、30秒かかっていた。gpt-3.5-turboに変更して10秒に短縮。

**変更内容**:
1. **API変更**:
   - `SearchRequest`に`search_llm_model`と`summary_llm_model`を追加
   - デフォルト: `search_llm_model="gpt-4o-mini"`, `summary_llm_model="gpt-3.5-turbo"`
2. **Backend**:
   - `agent.py`: LangGraphワークフロー内で2つのLLMを使い分け
   - `normalize_node`, `query_generation_node`: `search_llm_model`
   - `compare_node`: `summary_llm_model`
3. **Frontend**:
   - 設定ページにLLM選択UI追加（2段階）
   - 選択肢: gpt-4o, gpt-4o-mini, gpt-5, gpt-5.1, gpt-5.2（検索用）/ gpt-3.5-turbo, gpt-4o-mini, gpt-4o（要約用）

#### 3.2.2 FR-116: ハイブリッド検索

**背景**: セマンティック検索のみでは、一部フィールドを「なし」にした際にヒット精度が低下。

**変更内容**:
1. **ChromaDB設定変更**:
   - BM25キーワード検索の有効化（`chroma.search(mode="hybrid")`）
   - `hybrid_alpha`パラメータ追加（0.0〜1.0）
2. **API変更**:
   - `SearchRequest`に`search_mode`と`hybrid_alpha`を追加
   - `search_mode`: "semantic" | "keyword" | "hybrid"
3. **Backend**:
   - `agent.py`: `search_node`でChromaDBのハイブリッド検索を使用
   ```python
   if search_mode == "hybrid":
       results = collection.query(
           query_embeddings=embedding,
           n_results=100,
           mode="hybrid",
           alpha=hybrid_alpha  # 0.7推奨
       )
   ```
4. **Frontend**:
   - 検索ページに検索モード選択ドロップダウン追加
   - 設定ページで`hybrid_alpha`のスライダー（0.0〜1.0）

### 3.3 実装手順

#### Step 1: FR-112実装（1日）
1. `backend/agent.py`: LangGraph内で`search_llm`と`summary_llm`を分離
2. `backend/server.py`: `SearchRequest`に2つのパラメータ追加
3. `frontend/app/search/page.tsx`: APIリクエストに2つのモデルを含める
4. `frontend/app/settings/page.tsx`: モデル選択UI追加
5. テスト: 要約生成時間が10秒以内に短縮されることを確認

#### Step 2: FR-116実装（1.5日）
1. ChromaDBのドキュメント確認: ハイブリッド検索のAPI
2. `backend/agent.py`: `search_node`でハイブリッド検索実装
3. `backend/server.py`: `SearchRequest`に`search_mode`と`hybrid_alpha`追加
4. `frontend/app/search/page.tsx`: 検索モード選択UI追加
5. `frontend/app/settings/page.tsx`: `hybrid_alpha`スライダー追加
6. テスト: 評価機能でnDCG@5が向上することを確認

#### Step 3: 評価・チューニング（0.5日）
1. テストケース10件で評価実行
2. `hybrid_alpha`を0.5, 0.7, 0.9で比較
3. nDCG@5が最大になる値を推奨値として設定
4. ドキュメント更新（推奨設定を明記）

### 3.4 成功基準

- [ ] FR-112: 要約生成時間が30秒→10秒に短縮（gpt-3.5-turbo使用時）
- [ ] FR-112: 設定ページでモデル2段階選択が可能
- [ ] FR-116: ハイブリッド検索でnDCG@5 ≥ 0.85を達成
- [ ] FR-116: 部分検索（材料のみ、方法のみ）でも精度が向上
- [ ] E2Eテスト: 検索モード切り替え→結果の変化を確認

### 3.5 リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| ChromaDBがハイブリッド検索未対応 | 高 | 事前調査、代替手段（BM25ライブラリ併用） |
| gpt-5系モデルの利用制限 | 中 | API Keyの利用制限確認、フォールバック実装 |
| ハイブリッド検索で精度低下 | 中 | A/Bテスト、`hybrid_alpha`の最適化 |

---

## 4. Phase 3: ノート管理改善

### 4.1 目的

IT非専門者でも簡単にノートをアップロードできるようにする。FR-110（ノート取り込み改善）とFR-111（辞書自動抽出）を実装。

### 4.2 実装内容

#### 4.2.1 FR-110: ノート取り込み改善

**背景**: v2.0ではGCSに直接ファイルを配置する必要があり、IT非専門者には難しい。

**変更内容**:
1. **ローカルファイルアップロード**（優先）:
   - フロントエンド: ファイルドロップゾーン（ドラッグ&ドロップ対応）
   - API: `POST /ingest/upload` (multipart/form-data)
   - 複数ファイル同時アップロード対応
2. **Google Drive連携**（オプション）:
   - Google Drive APIで特定フォルダを監視
   - 新規.mdファイルを自動取り込み
   - バックグラウンドジョブ（定期実行）
3. **アーカイブ方式変更**:
   - `notes/archived/` → `notes/processed/`に名称変更
   - 取り込み済みノートを削除せず保持（Embeddingモデル変更時の再取り込み対応）

#### 4.2.2 FR-111: 辞書自動抽出

**背景**: ノート取り込み時に未知の化学物質名を手動で判定するのは手間がかかる。

**変更内容**:
1. **Sudachi形態素解析**:
   - `pip install sudachipy sudachidict_core`
   - 実験ノートから名詞を自動抽出
2. **LLM判定**:
   - 抽出された単語が「新規物質」か「表記揺れ」かをLLMで判定
   - 類似候補を提示（編集距離 + Embedding類似度）
3. **ユーザー確認UI**:
   - 新出単語リスト表示
   - 各単語に「新規追加」「表記揺れとして追加」「スキップ」ボタン
   - 一括承認機能

### 4.3 実装手順

#### Step 1: FR-110 - ローカルファイルアップロード（1.5日）
1. `frontend/app/ingest/page.tsx`: ファイルドロップゾーンUI
2. `backend/server.py`: `POST /ingest/upload` エンドポイント
3. ファイル保存: `notes/new/{team_id}/` → GCS or ローカル
4. アップロード後、既存の`/ingest` APIを自動実行
5. テスト: 複数ファイル同時アップロード→ChromaDB追加確認

#### Step 2: FR-110 - Google Drive連携（1日、オプション）
1. Google Cloud Consoleで Drive API有効化
2. OAuth 2.0認証フロー実装
3. `backend/google_drive.py`: フォルダ監視・ファイル取得
4. バックグラウンドジョブ: 5分ごとに新規ファイルチェック
5. テスト: Google Driveに.mdファイル配置→自動取り込み確認

#### Step 3: FR-111 - Sudachi形態素解析（1日）
1. `backend/term_extractor.py`: Sudachiで名詞抽出
2. 既存辞書との比較（編集距離、Embedding類似度）
3. LLMで複合語 vs 表記揺れを判定
4. テスト: サンプルノートで新出単語抽出→精度確認

#### Step 4: FR-111 - ユーザー確認UI（0.5日）
1. `frontend/app/ingest/page.tsx`: 新出単語確認UI
2. 一括承認・個別判定のワークフロー
3. 辞書更新API呼び出し
4. テスト: 新出単語→判定→辞書追加の一連フロー

### 4.4 成功基準

- [ ] FR-110: ブラウザから.mdファイルをドラッグ&ドロップでアップロード可能
- [ ] FR-110: Google Drive連携で自動取り込み可能（5分間隔）
- [ ] FR-110: IT非専門者の自力ノート取り込み成功率 ≥ 90%
- [ ] FR-111: 新出単語の自動抽出精度 ≥ 80%
- [ ] FR-111: LLM判定の精度 ≥ 85%（複合語 vs 表記揺れ）
- [ ] E2Eテスト: ノートアップロード→新出単語判定→辞書追加→検索反映

### 4.5 リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| Sudachiの専門用語対応不足 | 中 | カスタム辞書追加、LLM補完 |
| Google Drive API制限 | 低 | 無料枠監視、有料プラン検討 |
| 大量ファイルアップロードでタイムアウト | 中 | バッチ処理、非同期ジョブ化 |

---

## 5. Phase 4: UI/UX最終調整

### 5.1 目的

ユーザー体験を向上させる細かい改善。FR-113（再検索）、FR-114（コピー機能強化）、FR-115（評価機能改善）を実装。

### 5.2 実装内容

#### 5.2.1 FR-113: 再検索機能

**ワークフロー**:
1. 初回検索実行（目的・材料・方法）→ 結果表示
2. 「重点指示を追加して再検索」ボタンをクリック
3. モーダル表示: 重点指示入力欄
4. 「再検索」ボタン → 目的・材料・方法はそのまま、重点指示のみ追加
5. 結果を同じ画面に再表示

#### 5.2.2 FR-114: コピー機能強化

**ビューワー画面**:
- 各セクション（目的・材料・方法）に「検索条件として一括コピー」ボタン
- クリック→localStorageに保存→検索ページに遷移→自動入力

**検索画面（検索結果リスト）**:
- 各ノートカードに4つのボタン: [目的] [材料] [方法] [一括]
- クリック→左側フォームに即座に反映
- フィードバック: ボタンが一瞬グリーンに変化

#### 5.2.3 FR-115: 評価機能改善

**CSV出力**:
- カラム: 条件ID, Embeddingモデル, LLMモデル, プロンプト名, nDCG@5, nDCG@10, Precision@5, Precision@10, Recall@10, MRR, 正解1〜10_検出ランク
- 各評価履歴にエクスポートボタン

**UI改善**:
- デバッグ表示削除
- 評価履歴保存件数: 5件 → 50件

### 5.3 実装手順

#### Step 1: FR-113実装（0.5日）
1. `frontend/app/search/page.tsx`: 「重点指示を追加して再検索」ボタン追加
2. モーダルコンポーネント作成
3. 再検索時に既存の検索条件を保持
4. 履歴に両方の検索を保存

#### Step 2: FR-114実装（1日）
1. `frontend/app/viewer/[id]/page.tsx`: セクション別コピーボタン
2. `frontend/app/search/page.tsx`: 検索結果カードにコピーボタン（4種類）
3. localStorageを使った画面間データ受け渡し
4. トースト通知・ボタンフィードバック実装

#### Step 3: FR-115実装（0.5日）
1. `backend/evaluate.py`: CSV出力機能追加
2. `frontend/app/evaluate/page.tsx`: エクスポートボタン追加
3. 評価履歴の保存件数を50件に拡大
4. デバッグ表示削除

#### Step 4: 統合テスト（0.5日）
1. 全機能のE2Eテストシナリオ実行
2. レスポンシブ対応確認（モバイル・タブレット）
3. パフォーマンステスト（検索 < 5秒、要約 < 10秒）

### 5.4 成功基準

- [ ] FR-113: 再検索機能が直感的に使える
- [ ] FR-114: コピーボタンでワンクリック入力可能
- [ ] FR-115: CSV出力でnDCG@5とnDCG@10を同時確認可能
- [ ] 全機能がモバイルで快適に動作
- [ ] E2Eテスト: 全機能のハッピーパス100%カバー

---

## 6. Phase 5: 統合テスト・デプロイ

### 6.1 目的

v3.0の全機能を統合テストし、本番環境にデプロイ。

### 6.2 実装内容

#### 6.2.1 統合テスト
1. **E2Eテスト**:
   - マルチテナント: 2チーム × 2ユーザー
   - 検索: ハイブリッド検索、モデル2段階選択
   - ノート管理: ローカルアップロード、Google Drive連携
   - 評価: CSV出力、50件履歴
2. **パフォーマンステスト**:
   - 検索レスポンス < 5秒
   - 要約生成 < 10秒
   - 10,000件ノートでの検索速度
3. **セキュリティテスト**:
   - チーム間データ分離
   - 認証トークン検証
   - APIキーの安全な取り扱い

#### 6.2.2 デプロイ
1. **バックエンド**: Google Cloud Run
   - Dockerイメージビルド
   - 環境変数設定（Firebase、GCS）
   - デプロイ
2. **フロントエンド**: Vercel
   - GitHub連携
   - 環境変数設定（API URL、Firebase）
   - デプロイ
3. **データ移行**:
   - 既存データをマルチテナント構造に移行
   - バックアップ取得

### 6.3 実装手順

#### Step 1: E2Eテスト作成・実行（0.5日）
1. `frontend/tests/e2e/multi-tenant.spec.ts`
2. `frontend/tests/e2e/hybrid-search.spec.ts`
3. `frontend/tests/e2e/note-upload.spec.ts`
4. Playwright実行: `npm test`

#### Step 2: パフォーマンス・セキュリティテスト（0.5日）
1. 10,000件ノートの準備（スクリプト生成）
2. 検索速度測定
3. チーム間データ分離の検証

#### Step 3: デプロイ（0.5日）
1. バックエンド: Cloud Runデプロイ
2. フロントエンド: Vercelデプロイ
3. 本番環境でスモークテスト

#### Step 4: ドキュメント更新（0.5日）
1. USER_MANUAL.md更新（v3.0新機能）
2. DEPLOYMENT.md更新
3. CLAUDE.mdのリリース履歴更新

### 6.4 成功基準

- [ ] 全E2Eテスト合格（Phase 1-4の機能）
- [ ] nDCG@5 ≥ 0.85達成
- [ ] 検索レスポンス < 5秒
- [ ] 要約生成 < 10秒
- [ ] 本番環境で3チーム以上の利用実績

---

## 7. 実装の進め方（各フェーズ共通）

### 7.1 作業開始時

1. **ステアリングファイル作成**:
   ```bash
   /add-feature [機能名]
   ```
   - `.steering/YYYYMMDD-[機能名]/requirements.md`
   - `.steering/YYYYMMDD-[機能名]/design.md`
   - `.steering/YYYYMMDD-[機能名]/tasklist.md`

2. **既存コード調査**:
   - 関連ファイルをGrepで検索
   - 既存パターンを理解

### 7.2 実装中

1. **TDD（テスト駆動開発）**:
   - テストケース作成 → 実装 → テスト実行
2. **コミット粒度**:
   - 1機能=1コミット
   - コミットメッセージ: `Feat: [機能名]を実装`
3. **進捗管理**:
   - `tasklist.md`の各タスクに`[x]`をマーク

### 7.3 実装完了後

1. **E2Eテスト**:
   - Playwrightでテストシナリオ作成・実行
2. **レビュー**:
   - `/review-docs`でドキュメント更新確認
3. **デプロイ**:
   - 開発環境 → ステージング → 本番
4. **振り返り**:
   - `tasklist.md`に振り返りを記載

---

## 8. 優先順位とリスクマトリクス

### 8.1 機能別優先度

| 機能 | 優先度 | ビジネス価値 | 技術リスク | 実装コスト |
|------|-------|------------|-----------|-----------|
| FR-109（マルチテナント） | 🔴 最優先 | 高 | 高 | 大 |
| FR-116（ハイブリッド検索） | 🔴 高 | 高 | 中 | 中 |
| FR-112（モデル2段階選択） | 🟡 中 | 中 | 低 | 小 |
| FR-110（ノート取り込み改善） | 🟡 中 | 高 | 低 | 中 |
| FR-111（辞書自動抽出） | 🟡 中 | 中 | 中 | 中 |
| FR-113（再検索機能） | 🟢 低 | 低 | 低 | 小 |
| FR-114（コピー機能強化） | 🟢 低 | 低 | 低 | 小 |
| FR-115（評価機能改善） | 🟢 低 | 低 | 低 | 小 |

### 8.2 クリティカルパス

```
Phase 1（マルチテナント）
  ↓ 【ブロッカー】全機能の前提
Phase 2（コア検索強化）
  ↓ 【並行可能】
Phase 3（ノート管理改善） + Phase 4（UI/UX改善）
  ↓
Phase 5（統合テスト・デプロイ）
```

**Phase 3とPhase 4は並行実装可能**（依存関係なし）

---

## 9. 次のアクション

### 9.1 即座に開始すべきこと

1. **Phase 1の準備**:
   - Firebase Consoleでプロジェクト作成
   - Google Cloud Consoleで必要なAPI有効化
   - 開発環境のセットアップ確認

2. **ステアリングファイル作成**:
   ```bash
   /add-feature マルチテナント基盤整備
   ```

3. **タスクの詳細化**:
   - Phase 1のStep 1-5をさらに細分化
   - 各タスクの所要時間見積もり

### 9.2 質問・確認事項

1. **実装の優先順位**:
   - この計画で進めてよいか？
   - Phase 3とPhase 4を並行実装するか、順次実装するか？

2. **技術選定**:
   - Firebase Authenticationでよいか？（代替: Auth0, Supabase Auth）
   - Google Drive連携を実装するか、ローカルアップロードのみか？

3. **スケジュール**:
   - 11-17日（2-3週間）の目安でよいか？
   - 各フェーズの完了基準は明確か？

---

**作成日**: 2025-12-31
**バージョン**: v3.0 実装計画 初版
