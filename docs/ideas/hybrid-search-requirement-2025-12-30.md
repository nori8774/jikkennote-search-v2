# ハイブリッド検索機能の要件（2025-12-30）

## 背景

### 現在の問題

**症状：**
- ID1-2のノートと同じ目的・材料・方法を全て入力 → ✅ 正しくヒット
- 目的を「なし」として材料・方法のみで検索 → ❌ ヒットしない
- この問題は複数の検索条件の組み合わせで発生

**プロンプト改良の限界：**
- 様々なプロンプト改良を試したが、根本的な解決に至らない
- セマンティック検索（Embedding）の仕組み上の限界がある可能性

### 検索対象の特性分析

**目的フィールド：**
- 文章形式が多い
- 「〇〇を調べるため」「△△の効果を確認する」など
- → **セマンティック検索が適している**

**材料フィールド：**
- 化学物質名と容量の羅列
- 「エタノール 100ml」「塩化ナトリウム 5g」など
- 固有名詞が重要
- → **キーワード検索が適している可能性**

**方法フィールド：**
- 材料に登場した化学物質の処理手順
- 「エタノールを攪拌」「NaClを溶解」など
- 具体的な動詞と固有名詞の組み合わせ
- → **キーワード検索が適している可能性**

## 提案：ハイブリッド検索の実装

### 概要

TPOに応じて、**キーワード検索**と**セマンティック検索**を使い分けられるハイブリッド検索システムを構築する。

### 検索モード

1. **セマンティック検索（デフォルト）**
   - 現在の実装（Embedding + ChromaDB）
   - 文章の意味的類似性で検索
   - 目的など文章フィールドに強い

2. **キーワード検索**
   - BM25などのトークンベース検索
   - 固有名詞・専門用語に強い
   - 材料・方法フィールドに適している

3. **ハイブリッド検索**
   - セマンティック + キーワードの組み合わせ
   - 両者のスコアを重み付け統合
   - 最も精度が高い（推奨）

### UI設計

**検索画面に追加：**
- 検索モード選択ドロップダウン
  - [ ] セマンティック検索（デフォルト）
  - [ ] キーワード検索
  - [ ] ハイブリッド検索（推奨）

**設定画面に追加：**
- ハイブリッド検索の重み調整
  - セマンティックスコア重み：0.7（デフォルト）
  - キーワードスコア重み：0.3（デフォルト）

### 技術実装

**ChromaDBのハイブリッド検索機能：**
- ChromaDBは元々BM25 + Embedding検索をサポート
- `query_mode="hybrid"` で利用可能
- スコアの重み付けは `alpha` パラメータで調整

**実装箇所：**
1. `backend/agent.py` - SearchNodeでの検索ロジック修正
2. `backend/server.py` - `/search` APIに `search_mode` パラメータ追加
3. `frontend/app/search/page.tsx` - UI追加
4. `frontend/app/settings/page.tsx` - 重み設定UI追加

### API変更

**POST /search**

```json
{
  "purpose": "...",
  "materials": "...",
  "methods": "...",
  "focus": "...",
  "search_mode": "hybrid",  // 新規追加: "semantic" | "keyword" | "hybrid"
  "hybrid_alpha": 0.7,      // 新規追加: セマンティック重み（0.0-1.0）
  "openai_api_key": "...",
  "cohere_api_key": "..."
}
```

### 期待される効果

**検索精度の向上：**
- 目的のみ → セマンティック検索で文脈理解
- 材料のみ → キーワード検索で固有名詞を正確に捕捉
- 材料+方法 → ハイブリッド検索で両方の長所を活用

**部分検索の改善：**
- 一部フィールドを「なし」にした場合でも、残りのフィールドで適切に検索
- ID1-2の問題が解決される見込み

**ユーザーの柔軟性：**
- 検索対象の性質に応じて最適な検索モードを選択可能
- デフォルトはセマンティックで、必要に応じて切り替え

## 実装優先度

**Phase 3.1（高優先度）**

この機能は検索精度の根本的な問題に対処するため、v3.0の主要機能として追加すべき。

**理由：**
1. プロンプト改良だけでは解決できない可能性が高い
2. 実験ノート検索システムのコア機能に直結
3. ChromaDBがネイティブサポートしているため実装コストは低い
4. ユーザー体験が大幅に向上

## 参考資料

- [ChromaDB Hybrid Search](https://docs.trychroma.com/guides#hybrid-search)
- BM25アルゴリズム：トークンベースの検索アルゴリズム
- Embedding + BM25のハイブリッド手法は多くの検索システムで採用されている

---

**作成日**: 2025-12-30
**優先度**: 高
**ステータス**: 要件定義完了 → 永続ドキュメントへ反映予定
