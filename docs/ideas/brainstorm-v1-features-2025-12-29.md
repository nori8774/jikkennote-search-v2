# v1機能追加ブレインストーミング記録

**日付**: 2025-12-29
**目的**: jikkennote-search v1への機能追加・改善点の洗い出し
**参加者**: 開発チーム

---

## 背景

jikkennote-searchは実験ノート検索システムとして評価可能な状態まで完成している。しかし、実運用を想定すると改良・機能追加が必要な箇所が見えてきた。

元のシステム（jikkennote-search）を保護しながら新しいアイデアを試すため、jikkennote-search_v1として新プロジェクトを立ち上げ、以下の改善を検討した。

---

## 1. マルチテナント対応

### 背景・課題
- 現状は単一ユーザー・単一データベース
- 複数チームで同じアプリを使いたい
- チーム間でデータを分離したい（セキュリティ）
- IT関係でないユーザーでも使いやすくしたい

### 要件

#### ユーザー管理
- **認証**: Googleログイン（Firebase Authentication）
  - 理由: 誰でもGoogleアカウントを持っている
  - パスワード管理不要
  - ハードルが低い
- **複数チーム所属**: 1ユーザーが複数チームに参加可能
- **権限**: PoCのため全員同等（全員が編集可能）

#### チーム管理
- チーム作成 → 招待コードで参加（Slack的）
- チーム内でノート・辞書を共有
- チーム間は完全に独立（他チームのデータは見えない）

#### データ構造
```
gs://jikkennote-storage/
└── teams/
    ├── team_abc123/
    │   ├── chroma-db/           # Embedding保存
    │   ├── notes/
    │   │   ├── new/            # 取り込み待ち
    │   │   └── processed/      # 取り込み済み（アーカイブ）
    │   ├── dictionary.yaml
    │   └── prompts/
    └── team_xyz789/
        └── ...

ローカル開発時も同じ構造：
backend/teams/team_abc123/...
```

---

## 2. ノート取り込み改善

### 背景・課題
- 現状: GCSに手動配置 → IT非専門者には難しい
- エンベディングモデル変更時に再取り込みしたい
- 取り込んだノートが削除されてしまう

### 要件

#### 取り込み方法
1. **ローカルファイルアップロード**（最優先）
   - ブラウザから.mdファイルを選択→アップロード
   - 複数ファイル一括対応
2. **Google Drive連携**
   - Google Driveフォルダを指定→定期同期
   - 既存コードが使えそう

#### アーカイブ方式
- `new/` に配置 → 取り込み実行 → `processed/` に移動（削除しない）
- エンベディングモデル変更時 → `processed/`から再取り込み可能

#### 辞書の自動抽出（難しい部分）

**複合語の扱い：**
- 「抗原」「抗体」「抗原抗体反応」→ **別の用語として共存**
- 「こうげんこうたい反応」→「抗原抗体反応」の表記揺れとして名寄せ

**技術的アプローチ：**
- **Sudachi（形態素解析）+ LLM** で複合語判定
- LLMに「これは複合語か、表記揺れか」を判定させる
- ユーザーに最終確認させる（取り込み時にUI表示）

**ライフサイクル：**
1. ノート取り込み時に新出単語を自動抽出
2. Sudachi + LLMで複合語・表記揺れを判定
3. ユーザーがUIで確認・修正
4. 辞書に反映
5. ユーザーは後から辞書UIで修正可能

---

## 3. 検索機能改善

### 背景・課題
- 比較・要約生成が30秒かかる（遅い）
- 再検索機能が不完全（重点指示を追加して再検索できない）
- モデル選択が単一（検索も要約も同じモデル）

### 要件

#### 速度改善
**現状：**
- デフォルトLLM: `gpt-4o-mini`（すでに軽量）
- 比較ノード（要約生成）で30秒

**改善策：**
- モデルを2段階に分離
  - **検索・判定用LLM**: GPT-4o, GPT-5系（高品質）
  - **要約生成用LLM**: gpt-3.5-turbo（デフォルト、高速）
- ユーザーが設定ページで選択可能

#### モデル選択の拡充
**検索・判定用LLM**（正規化、クエリ生成、検索で使用）
- gpt-4o
- gpt-4o-mini
- **gpt-5**（新規追加）
- **gpt-5.1**（新規追加）
- **gpt-5.2**（新規追加、最新）

**要約生成用LLM**（比較ノードのみ）
- **gpt-3.5-turbo**（デフォルト、高速）
- gpt-4o-mini
- gpt-4o

#### 再検索機能
**現状：**
- 初回検索時に重点指示を入力可能
- 結果を見てから追加指示で再検索できない

**改善：**
```
初回検索
  ↓
結果を確認
  ↓
「もっと材料の量に注目して」などの追加指示入力
  ↓
重点指示を追加して再検索ボタン
  ↓
目的・材料・方法はそのまま、重点指示のみ追加して再実行
```

---

## 4. コピー機能強化

### 背景・課題
- 検索結果から再検索する際、手動でコピペが面倒
- ビューワーから検索条件を作るのが面倒

### 要件

#### ビューワー画面（/viewer）
**追加機能**：「検索条件として一括コピー」ボタン
- ノートタイトルの横に配置
- 目的・材料・方法をlocalStorageに保存
- 検索ページ（/search）に遷移
- フォームに自動入力

#### 検索画面（/search）
**現状**：検索結果の各ノートに
- 「材料をコピー」ボタン ✅
- 「方法をコピー」ボタン ✅

**追加**：
- **「目的」ボタン**（新規）
- **「材料」ボタン**（既存）
- **「方法」ボタン**（既存）
- **「一括」ボタン**（新規）

**動作**：クリック → 左側フォームに即座に反映

**配置イメージ**：
```
┌─────────────────────────────────────┐
│ ノート 1  [ID3-14 →]                │
│ [目的] [材料] [方法] [一括]          │  ← ボタン配置
│ ノート内容...                        │
└─────────────────────────────────────┘
```

---

## 5. 評価機能改善

### 背景・課題
- デバッグ用の入力条件表示が不要（検索クエリが正常に動作することを確認済み）
- 評価結果をCSVで出力したい
- 評価履歴が5件では連続評価できない

### 要件

#### デバッグ表示削除
- 入力条件（目的、材料、実験手順、重点指示）の詳細表示を削除
- すっきりしたUIに

#### CSV出力
**カラム構成**：
```csv
条件ID,Embeddingモデル,LLMモデル,プロンプト名,nDCG@10,Precision@10,Recall@10,MRR,正解1_検出ランク,正解2_検出ランク,...,正解10_検出ランク
1,text-embedding-3-small,gpt-4o-mini,デフォルト,0.850,0.700,0.600,0.950,1,2,...,未検出
2,text-embedding-3-small,gpt-4o-mini,デフォルト,0.920,0.800,0.750,1.000,1,3,...,5
```

**含まれる情報**：
- 使用したEmbeddingモデル
- 使用した検索・判定用LLMモデル
- プロンプト名（保存名）
- 各条件のスコア（nDCG, Precision, Recall, MRR）
- 正解に対して何位で検出されたか（10件分）

**UI**：
- 評価履歴の各項目に「CSVエクスポート」ボタン追加

#### 履歴保存件数
- **5件 → 50件** に拡大
- 連続評価に対応

---

## 技術的な検討事項

### Sudachiについて
- 日本語形態素解析器
- 複合語の分割・結合に対応
- 化学用語・専門用語の辞書カスタマイズ可能
- LLMと組み合わせることで高精度な用語抽出が可能

### GPT-5シリーズについて
- GPT-5、GPT-5.1、GPT-5.2がOpenAI APIで利用可能（2025年12月時点）
- GPT-5.2が最新フラッグシップモデル
- 推論能力が向上しているため、検索・判定に有効

### Firebase Authenticationについて
- 無料枠あり
- Googleログインが簡単
- Next.jsとの連携が容易
- チーム管理はFirestoreで実装可能

---

## 実装優先順位（提案）

### Phase 1: 基盤整備
1. マルチテナント対応（認証、データ構造）
2. ノート取り込み改善（ローカルアップロード、アーカイブ）

### Phase 2: コア機能改善
3. 辞書自動抽出（Sudachi + LLM）
4. モデル2段階選択
5. 再検索機能

### Phase 3: UX改善
6. コピー機能強化
7. 評価機能改善（CSV出力、履歴50件）

---

## 次のステップ

1. ✅ ブレスト内容をアーカイブ（このファイル）
2. 🔄 v1改善点を圧縮・整理したドキュメント作成
3. 🔄 永続ドキュメント更新
   - product-requirements.md
   - functional-design.md
   - architecture.md
   - api-specification.md
   - repository-structure.md

---

## 参考リンク

### 技術調査
- [OpenAI Models 2025](https://platform.openai.com/docs/models)
- [Sudachi Documentation](https://github.com/WorksApplications/Sudachi)
- [Firebase Authentication](https://firebase.google.com/docs/auth)

---

**記録者**: Claude Sonnet 4.5
**保存日**: 2025-12-29
