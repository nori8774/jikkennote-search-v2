# 実験ノート検索システム - 初期アイデアメモ

## このドキュメントの位置づけ

このドキュメントは壁打ち・ブレストの成果物で、正式な仕様書ではありません。

## プロジェクトビジョン

LangChain v2で構築した実験ノート検索システムをベースに、ユーザビリティとカスタマイズ性を大幅に向上させた機能拡張版を開発する。

**一言で言うと**: 研究者がターミナルとブラウザを行き来せず、カスタマイズ可能なプロンプトで高精度な実験ノート検索ができるWebアプリケーション

---

## 解決したい課題

### 今困っていること

1. **プロンプトがハードコードされている**
   - LLMに投げるプロンプトがコード内に直書き
   - 調整するたびにコード修正→再起動が必要
   - 実験内容によって最適なプロンプトが異なるが、簡単に切り替えられない

2. **検索結果の再利用が面倒**
   - 検索結果の材料・方法を参考にしたいのに、手動でコピペ
   - 検索履歴が残らないので、過去に何を調べたか忘れる
   - 同じような検索を何度も繰り返している

3. **ノート取り込み時の材料名管理が手作業**
   - 新しい材料が出てくるたびに手動で辞書更新
   - 「DMSO」と「ジメチルスルホキシド」が同じかどうか判断が面倒
   - 表記揺れが増えると検索精度が落ちる

4. **検索精度を定量的に評価できない**
   - 「なんとなく良さそう」でプロンプトやモデルを選んでいる
   - 本当に最適な設定なのか分からない
   - nDCGなどの客観的指標が欲しい

5. **チーム内での共有が難しい**
   - ローカル環境でしか動かない
   - 各自がセットアップする必要がある
   - URLでアクセスできるWebアプリにしたい

---

## ターゲットユーザー

### ペルソナ1: 実験担当研究者

- **年齢**: 25-40歳
- **職業**: 研究機関・企業の研究員
- **経験**: 化学・材料科学の実験を日常的に実施
- **今困ってること**:
  - 過去の実験ノートから似た条件の実験を探すのに時間がかかる
  - 自分のノートだけでなく、先輩や同僚のノートも参照したい
  - 材料名の表記揺れで検索結果が変わってしまう

- **欲しいもの**:
  - 目的・材料・方法を入力するだけで関連ノートが見つかる
  - 検索結果をすぐに次の実験計画に活用できる
  - 検索条件をカスタマイズして精度を上げられる

### ペルソナ2: プロジェクトマネージャー

- **年齢**: 35-50歳
- **職業**: 研究プロジェクトのリーダー
- **経験**: チーム全体の研究進捗を管理
- **今困ってること**:
  - チーム全体の実験ノートを俯瞰して把握したい
  - どの実験が成功して、どの条件が失敗したか分析したい
  - 新メンバーがすぐに過去の知見を参照できる仕組みが欲しい

- **欲しいもの**:
  - チーム全員がアクセスできるWebアプリ
  - 検索結果を比較分析できる機能
  - 定量的な評価指標で検索精度を改善

---

## 主要機能の候補

### P0 (MVPで絶対必要)

#### 1. コア検索機能（既存システムから継承）
```
入力: 目的・材料・方法・重点指示
↓
正規化ノード（材料名統一）
↓
クエリ生成ノード（ベテラン/新人/マネージャー視点）
↓
ベクトル検索 + Cohere Reranking
↓
比較分析レポート生成
```

#### 2. プロンプト管理機能
```
UI上でプロンプトを編集・保存
- 正規化プロンプト
- クエリ生成プロンプト（3視点）
- 比較分析プロンプト

保存形式: YAMLファイル
最大保存数: 50件
初期設定へのリセット機能
```

#### 3. 検索結果コピー機能
```
検索結果の各ノート（上位3件）に「材料をコピー」「方法をコピー」ボタン
→ クリックで検索条件入力欄に自動反映
→ 条件を調整して再検索
```

#### 4. モデル選択UI
```
Embeddingモデル選択:
- text-embedding-3-small (デフォルト)
- text-embedding-3-large
- text-embedding-ada-002

LLMモデル選択:
- gpt-4o-mini (デフォルト)
- gpt-4o
- gpt-4-turbo
- gpt-3.5-turbo

各モデルのコスト・性能・速度を表示
```

### P1 (重要だけど後回しでもいい)

#### 5. 検索履歴管理
```
検索ごとに履歴を保存:
- 検索クエリ（目的・材料・方法・重点指示）
- 検索日時
- 上位10件のノートID + スコア
- 使用したプロンプト名

履歴一覧表示:
- テーブル形式で表示（日時 | クエリ要約 | 上位10件ノートID）
- ノートIDクリックでビューワー表示（モーダル）
- ソート・フィルタリング機能
- 再検索機能
```

#### 6. 実験ノート直接閲覧機能
```
ノートID入力 → 全文表示
- セクション別表示（目的・材料・方法・結果）
- 各セクションのコピーボタン
- 検索条件への反映機能
```

#### 7. 新出単語抽出と正規化辞書管理
```
ノート取り込み時:
1. 材料セクションから単語抽出
2. 既存辞書と照合
3. 新出単語をリストアップ

LLMで表記揺れ判定:
- 編集距離（Levenshtein距離）
- Embedding類似度
- LLMによる意味的判定
- 総合スコアで候補提示

ユーザーが判定:
- 表記揺れ → 既存エントリに追加
- 新規物質 → 新規エントリ作成
- スキップ → 辞書に追加しない

辞書管理UI:
- 閲覧・検索
- エントリ編集・削除
- エクスポート/インポート（YAML/JSON/CSV）
```

### P2 (あったら嬉しい)

#### 8. RAG性能評価機能
```
テストケース管理:
- Excel/CSVからインポート
- 手動作成・編集
- 各テストケース: クエリ + 正解ランキング

評価実行:
- nDCG@10
- Precision@K (K=3,5,10)
- Recall@10
- MRR

結果表示:
- スコア表示（数値 + グラフ）
- 正解 vs 実際のランキング比較
- 差分の可視化
```

#### 9. Google Drive統合 ⭐
```
目的: チーム内でノートと辞書を共有

機能:
- Google Drive APIで共有フォルダにアクセス
- フォルダ構成:
  notes/new/    ← 新規ノート
  notes/processed/ ← 取り込み済みノート
  master_dictionary.yaml ← 正規化辞書

設定:
- サービスアカウントキー（JSON）アップロード
- 共有フォルダーIDの入力
- 接続テスト機能
```

#### 10. インテリジェント単語抽出 ⭐
```
複数パターンで単語を生成:
例: "HbA1c捕捉抗体"
→ ["HbA1c捕捉抗体", "HbA1c", "捕捉抗体", "抗体"]

アルゴリズム:
1. 完全形を含める
2. 英数字と日本語の境界で分割
3. 化学接尾辞（〜酸、〜塩、〜抗体）を含む部分を抽出
```

#### 11. 表記揺れ自動検出 ⭐
```
新出単語を自動でグループ化:
1. 文字数が±2文字以内の単語同士を比較
2. 編集距離 + Embedding類似度を計算
3. LLMで最終判定（"variant" or "new"）
4. 候補をテーブル表示:
   - カラム: 単語1 | 単語2 | 類似度 | LLM判定 | 推奨正規化名 | 承認/却下
5. 一括承認/却下ボタン
6. 承認後、自動でYAML辞書を更新
```

---

## 差別化ポイント

### 既存ツールとの比較

| 特徴 | 本システム | 一般的なLLM検索 | フルテキスト検索 |
|------|-----------|----------------|----------------|
| プロンプトカスタマイズ | ✅✅✅ | △ (API経由) | ❌ |
| 材料名正規化 | ✅✅✅ | ❌ | ❌ |
| 多角的クエリ生成 | ✅ (3視点) | ❌ | ❌ |
| Reranking | ✅ (Cohere) | △ | ❌ |
| 検索結果コピー | ✅ | ❌ | ❌ |
| 検索履歴管理 | ✅ | △ | ❌ |
| 性能評価 | ✅ (nDCG等) | ❌ | ❌ |
| チーム共有 | ✅ (Webアプリ) | △ | △ |

### このツールの強み

1. **実験ノート特化**
   - 化学材料名の正規化に対応
   - 目的・材料・方法という構造化された入力
   - 実験ノート固有のプロンプト最適化

2. **カスタマイズ性**
   - UI上でプロンプトを簡単に編集
   - モデル選択で精度とコストをバランス
   - 検索履歴から再検索・調整が可能

3. **ワークフローに統合**
   - 検索結果をそのまま次の検索条件に活用
   - ノート取り込み時に自動で辞書更新
   - 評価機能で継続的に精度改善

4. **シンプル**
   - 研究者が本当に必要な機能だけ
   - URLアクセスでチーム内共有
   - 各自のAPIキー使用でコスト分散

---

## 技術的な検討事項

### データの保存方法

**候補1: ローカルファイル（現行）**
- シンプル、特別なソフトウェア不要
- フォルダパスを設定画面で指定可能
- Gitで管理できる（チーム共有の場合）

**候補2: Google Cloud Storage (本番環境)**
- Cloud Run + GCS で永続化
- ノート、辞書、プロンプトをGCSに保存
- ChromaDBもGCSバケットに同期

**結論**: ローカル開発はローカルファイル、本番環境はGCS

### RAG評価指標

**nDCG@10 (Normalized Discounted Cumulative Gain)**
- DCG@K = Σ (relevance_i / log2(i+1)) for i=1 to K
- IDCG = 理想的なランキングでのDCG
- nDCG@K = DCG@K / IDCG@K

**Precision@K**
- 上位K件中、正解の割合

**Recall@K**
- 全正解中、上位K件に含まれる割合

**MRR (Mean Reciprocal Rank)**
- 1 / (最初の正解の順位)

### Google Drive統合の方法

**ライブラリ**:
- google-api-python-client
- google-auth
- google-auth-httplib2

**認証**:
- サービスアカウント方式
- JSON keyファイルをlocalStorageに暗号化保存
- スコープ: drive.file（最小限）

**フォルダ構成**:
```
Google Drive共有フォルダー/
├── notes/
│   ├── new/          ← 新規ノート
│   └── processed/    ← 取り込み済みノート
└── master_dictionary.yaml  ← 正規化辞書
```

---

## 非機能要件（とりあえず）

### パフォーマンス
- 検索レスポンス: < 5秒
- ノート取り込み: < 10秒/件
- 新出単語抽出: < 10秒/ノート

### 使いやすさ
- 既存UIデザインとの統一感
- レスポンシブ対応（モバイル・タブレット）
- エラーメッセージの日本語化

### 信頼性
- ChromaDBの永続化ストレージ
- 正規化辞書のバックアップ
- 危険な操作（DB削除など）には確認ダイアログ

### 拡張性
- 新しいプロンプト追加が容易
- 新しいEmbeddingモデル対応
- 評価指標の追加

---

## 成功指標（とりあえず）

### ユーザー視点
- **導入率**: チーム10人中7人以上が利用
- **満足度**: Net Promoter Score (NPS) が30以上
- **時間削減**: 実験ノート検索時間が半分になる

### プロダクト視点
- **検索精度**: nDCG@10 ≥ 0.8
- **検索速度**: レスポンスタイム < 5秒
- **継続率**: 1ヶ月後も使い続けている人が70%以上

---

## 今後の検討事項

### まだ決めてないこと

1. **マルチテナント対応**
   - ユーザーID/ワークスペースIDの導入
   - GCSでフォルダ分離
   - ChromaDBコレクション分離

2. **通知機能**
   - WebSocketで進捗リアルタイム表示
   - メール通知（取り込み完了、評価結果）

3. **高度な検索機能**
   - ファセット検索（カテゴリ、日付範囲）
   - フィルタリング（材料、手法）
   - 保存された検索条件

4. **協働機能**
   - ノートへのコメント・アノテーション
   - チーム内共有・権限管理
   - 変更履歴追跡

### 技術的に不安なこと

1. **ChromaDB互換性**
   - Embeddingモデル変更時のDB互換性喪失
   - 対策: モデル変更時に警告 + リセット機能

2. **大量ノートの検索速度**
   - ノートが1万件を超えたらどうなる？
   - 対策: インデックス最適化、ページネーション

3. **Google Drive API制限**
   - リクエスト数制限（1ユーザー1000リクエスト/100秒）
   - 対策: キャッシング、バッチ処理

---

## 次のステップ

1. **このドキュメントのレビュー**
   - 抜けてる視点はないか？
   - 優先順位は妥当か？

2. **正式なドキュメント作成**
   - product-requirements.md（プロダクト要求定義書）
   - functional-design.md（機能設計書）
   - architecture.md（技術仕様書）
   - development-guidelines.md（開発ガイドライン）

3. **フェーズ別実装**
   - Phase 1: 基盤整備 ✅ 完了
   - Phase 2: コア機能実装 ✅ 完了
   - Phase 3: ノート管理・辞書機能実装 ✅ 完了
   - Phase 4: 履歴・評価機能実装 ✅ 完了
   - Phase 5: UI/UX改善・テスト ✅ 完了
   - Phase 6: デプロイ・ドキュメント ✅ 完了

4. **本番環境デプロイ**
   - Vercelでフロントエンド
   - Google Cloud Runでバックエンド
   - GCSでストレージ
   - チーム内で利用開始

---

**作成日**: 2025-12-19
**最終更新**: 2025-12-29
**ベースシステム**: LangChain_v2 実験ノート検索システム
